<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pecuario GB - v40.7</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    header {
      background: #4b3b2d;
      color: #fff;
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
header small {
      display: block;
      font-size: 11px;
      opacity: 0.9;
    }
    .subleyenda {
      font-size: 11px;
      margin-top: 4px;
      color: #f0e0c0;
      font-style: italic;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 6px;
      background: #eae7e2;
      border-bottom: 1px solid #d0c8c0;
      position: sticky;
      top: var(--headerH, 74px);
      z-index: 4;
    }
    nav button {
      flex: 1 1 calc(25% - 4px);
      min-width: 120px;
      padding: 6px 4px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #b9b1a7;
      background: #ffffff;
      cursor: pointer;
    }
    nav button.activo {
      background: #8b4513;
      color: #fff;
      border-color: #5a2f0c;
      font-weight: 600;
    }
    main {
      padding: 10px;
      max-width: 1100px;
      margin: 0 auto 24px auto;
    }
    section.modulo {
      display: none;
      background: #ffffff;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.10);
      margin-bottom: 16px;
    }
    section.modulo.activo { display: block; }

    h2 { font-size: 17px; margin-top: 0; margin-bottom: 6px; color: #4b3b2d; }
    h3 { font-size: 14px; margin-bottom: 4px; color: #5a4636; }
    p  { font-size: 12px; margin: 4px 0; }

    form { margin-top: 6px; margin-bottom: 10px; }
    label {
      display: block;
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #c7c0b8;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .fila-dos {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 6px;
    }
    .fila-tres {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 6px;
    }
    .acciones {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .acciones button {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .btn-primario   { background: #27ae60; color: #fff; }
    .btn-secundario { background: #95a5a6; color: #fff; }
    .btn-alerta     { background: #c0392b; color: #fff; }
    .btn-terciario  { background: #8b4513; color: #fff; }

    .nota {
      font-size: 11px;
      color: #7f8c8d;
      margin-top: 4px;
    }

    .tarjetas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .tarjeta {
      background: #faf7f3;
      border-radius: 4px;
      padding: 8px;
      border: 1px solid #e1d7cd;
      font-size: 12px;
    }
    .tarjeta strong { display: block; margin-bottom: 4px; }

    
    /* Pronóstico 7 días (Panel) */
    .wx-wrap{ margin-top: 6px; }
    .wx-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .wx-status{ font-size:11px; color:#6b7280; }
    .wx-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(92px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .wx-card{
      background:#ffffff;
      border:1px solid #e1d7cd;
      border-radius: 14px;
      padding: 10px 8px;
      text-align:center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      min-height: 130px;
    }
    .wx-day{ font-weight: 800; font-size: 12px; color:#4b3b2d; letter-spacing:0.2px; }
    .wx-icon{ display:flex; justify-content:center; margin: 10px 0 12px; }
    .wx-icon svg{ width: 28px; height: 28px; }
    .wx-temp{ font-weight: 900; font-size: 13px; color:#111827; }
    .wx-temp small{ font-weight: 800; font-size: 11px; color:#6b7280; }
    .wx-rain{ font-size:11px; color:#374151; margin-top:4px; font-weight:800; }
    .wx-accum{ margin-top:10px; font-size:12px; color:#374151; font-weight:800; }

.lista {
      margin-top: 8px;
      font-size: 12px;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 6px 8px;
      max-height: 260px;
      overflow-y: auto;
      border: 1px solid #eee;
    }
    .lista div {
      padding: 4px 0;
      border-bottom: 1px dashed #ddd;
    }
    .lista div:last-child { border-bottom: none; }

    details {
      margin-top: 6px;
      border-radius: 4px;
      background: #f7f5f2;
      border: 1px solid #e2dbd4;
      padding: 4px 6px;
      font-size: 12px;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: #4b3b2d;
    }

    /* Subtabs internos */
    .subtabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 6px 0 10px 0;
    }
    .subtabs button {
      border: 1px solid #b9b1a7;
      background: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .subtabs button.activo {
      background: #8b4513;
      border-color: #5a2f0c;
      color: #fff;
      font-weight: 600;
    }
    .submodulo { display: none; }
    .submodulo.activo { display: block; }


    .userbar{
      margin-top: 0;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: flex-end;
      flex-wrap:wrap;
    }
    .userbar select{
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid #e5e7eb;
      font-weight:600;
    }

    /* Portada (overlay) */
    #portada {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background-image: url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%201200%20800%27%3E%0A%20%20%3Crect%20width%3D%271200%27%20height%3D%27800%27%20fill%3D%27%23f8fafc%27%2F%3E%0A%20%20%3Cpath%20d%3D%27M340%20280%0A%20%20%20%20%20%20%20%20%20%20%20C290%20210%2C240%20190%2C180%20190%0A%20%20%20%20%20%20%20%20%20%20%20C210%20240%2C230%20300%2C230%20360%0A%20%20%20%20%20%20%20%20%20%20%20C230%20470%2C300%20555%2C400%20590%0A%20%20%20%20%20%20%20%20%20%20%20C460%20610%2C520%20610%2C600%20590%0A%20%20%20%20%20%20%20%20%20%20%20C700%20555%2C770%20470%2C770%20360%0A%20%20%20%20%20%20%20%20%20%20%20C770%20300%2C790%20240%2C820%20190%0A%20%20%20%20%20%20%20%20%20%20%20C760%20190%2C710%20210%2C660%20280%0A%20%20%20%20%20%20%20%20%20%20%20C635%20255%2C615%20240%2C600%20232%0A%20%20%20%20%20%20%20%20%20%20%20C585%20240%2C565%20255%2C540%20280%0A%20%20%20%20%20%20%20%20%20%20%20C505%20250%2C470%20235%2C400%20235%0A%20%20%20%20%20%20%20%20%20%20%20C330%20235%2C375%20250%2C340%20280Z%27%20fill%3D%27%23d10000%27%20fill-opacity%3D%270.10%27%2F%3E%0A%20%20%3Cpath%20d%3D%27M505%20330%0A%20%20%20%20%20%20%20%20%20%20%20C520%20300%2C560%20282%2C600%20282%0A%20%20%20%20%20%20%20%20%20%20%20C640%20282%2C680%20300%2C695%20330%0A%20%20%20%20%20%20%20%20%20%20%20C670%20315%2C640%20310%2C600%20310%0A%20%20%20%20%20%20%20%20%20%20%20C560%20310%2C530%20315%2C505%20330Z%27%20fill%3D%27none%27%20stroke%3D%27%23d10000%27%20stroke-opacity%3D%270.14%27%20stroke-width%3D%2710%27%20stroke-linecap%3D%27round%27%20stroke-linejoin%3D%27round%27%2F%3E%0A%20%20%3Cpath%20d%3D%27M0%20660%0A%20%20%20%20%20%20%20%20%20%20%20L170%20640%0A%20%20%20%20%20%20%20%20%20%20%20L260%20610%0A%20%20%20%20%20%20%20%20%20%20%20L330%20585%0A%20%20%20%20%20%20%20%20%20%20%20L420%20560%0A%20%20%20%20%20%20%20%20%20%20%20L520%20520%0A%20%20%20%20%20%20%20%20%20%20%20L600%20540%0A%20%20%20%20%20%20%20%20%20%20%20L690%20500%0A%20%20%20%20%20%20%20%20%20%20%20L780%20535%0A%20%20%20%20%20%20%20%20%20%20%20L870%20505%0A%20%20%20%20%20%20%20%20%20%20%20L960%20545%0A%20%20%20%20%20%20%20%20%20%20%20L1040%20520%0A%20%20%20%20%20%20%20%20%20%20%20L1200%20560%0A%20%20%20%20%20%20%20%20%20%20%20L1200%20800%0A%20%20%20%20%20%20%20%20%20%20%20L0%20800%20Z%27%20fill%3D%27%23111827%27%20fill-opacity%3D%270.07%27%2F%3E%0A%3C%2Fsvg%3E");
      background-size: cover;
      background-color: #f8fafc;
      background-position: center;
    }
    #portada .marco {
      width: min(820px, 100%);
      border: 2px solid rgba(209,0,0,0.55);
      background: rgba(255,255,255,0.78);
      border-radius: 14px;
      padding: 18px 18px 14px 18px;
      box-shadow: 0 18px 60px rgba(17,24,39,0.18);
      position: relative;
      overflow: hidden;
    }
    #portada h1 {
      margin: 0;
      color: #111827;
      font-size: clamp(34px, 6vw, 58px);
      letter-spacing: 1px;
      text-transform: uppercase;
      text-align: center;
    }
    #portada h2 {
      margin: 10px 0 0 0;
      color: #9b0000;
      font-weight: 600;
      font-size: clamp(16px, 3vw, 22px);
      text-align: center;
      letter-spacing: 0.5px;
    }
    #portada .accionesPortada {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    #portada .notaLegal {
      position: absolute;
      right: 12px;
      bottom: 10px;
      color: rgba(240,224,192,0.85);
      font-size: 10px;
      text-align: right;
      max-width: 320px;
    }
    #portada .watermark {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      transform: rotate(-18deg);
      opacity: 0.22;
    }
    #portada .watermark span {
      color: #fff;
      font-weight: 800;
      font-size: clamp(34px, 7vw, 84px);
      letter-spacing: 1px;
      text-transform: uppercase;
      text-align: center;
    }

    /* Potreros: canvas */
    .mapa-wrap {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    canvas#canvasPotrero {
      width: 100%;
      height: 220px;
      background: #fff;
      border: 1px solid #e1d7cd;
      border-radius: 8px;
    }
    .puntos {
      font-size: 11px;
      color: #4b3b2d;
      background: #faf7f3;
      border: 1px solid #e1d7cd;
      border-radius: 8px;
      padding: 8px;
      max-height: 180px;
      overflow: auto;
    }
    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f0e0c0;
      color: #4b3b2d;
      font-weight: 700;
      font-size: 11px;
      margin-left: 6px;
    }

    /* Modal suplementos */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9998;
    }
    .modal.activo { display: flex; }
    .modal .panel {
      width: min(860px, 100%);
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.35);
    }
    .modal .panel header {
      position: relative;
      top: auto;
      z-index: auto;
      background: transparent;
      color: #4b3b2d;
      padding: 0;
      margin-bottom: 6px;
    }

    @media (max-width: 700px) {
      nav button { flex: 1 1 calc(50% - 4px); min-width: 140px; }
      .fila-dos, .fila-tres { grid-template-columns: 1fr; }}
  </style>
</head>
<body>

<!-- PORTADA (se cierra con "Entrar") -->
<div id="portada" role="dialog" aria-modal="true">
  <div class="marco">
    <div class="watermark"><span>APP EN ETAPA DE PRUEBA</span></div>

    <h1>PECUARIO GB</h1>
    <h2>PERMANENCIA y CRECIMIENTO</h2>

    <div class="accionesPortada">
      <button class="btn-primario" id="btnEntrar">Entrar a la app</button>
      <button class="btn-secundario" id="btnCerrarMarca">Ocultar “etapa de prueba”</button>
    </div>

    <div class="notaLegal">
      App en proceso de registro en Propiedad Intelectual. Derechos protegidos.
    </div>
  </div>
</div>

<header>
  <div class="toprow">
    <h1>Pecuario GB <span class="chip">v40.7</span></h1>
    <div class="userbar">
    <span><b>Usuario:</b></span>
    <select id="selUsuario"></select>
    <span class="chip" id="lblRol" style="background:#111827;color:#fff;">—</span>
  </div>
  </div>
  <small>Control operativo integral de ganado bovino</small>
  <div class="subleyenda">Información para la permanencia y crecimiento de tu rancho</div>

</header>

<nav>
  <button data-modulo="panel" class="activo">Panel</button>
  <button data-modulo="animales">Animales</button>
  <button data-modulo="potreros">Potreros y Corrales</button>
  <button data-modulo="repro">Reproducción y partos</button>
  <button data-modulo="sanidad">Sanidad</button>
<button data-modulo="conta">Contabilidad</button>
  <button data-modulo="seguridad">Registros del Velador</button>
  <button data-modulo="maquinaria">Maquinaria y equipo</button>
  <button data-modulo="actividades">Actividades</button>
  <button data-modulo="reportes">Reportes</button>
  <button data-modulo="config">Perfil del rancho</button>
</nav>

<main>
  <!-- PANEL -->
  <section id="mod-panel" class="modulo activo">
    <h2>Panel general</h2>
    <p>Resumen rápido del rancho con base en los registros capturados.</p>
    <div class="tarjetas-grid">
      <div class="tarjeta" data-perm="animales">
        <strong>Animales registrados</strong>
        <span id="pnl-animales">0</span>
      </div>
      <div class="tarjeta" data-perm="animales">
        <strong>Pesajes registrados</strong>
        <span id="pnl-pesajes">0</span>
      </div>
      <div class="tarjeta" data-perm="repro">
        <strong>Nacimientos</strong>
        <span id="pnl-nacimientos">0</span>
      </div>
      <div class="tarjeta" data-perm="sanidad">
        <strong>Eventos de sanidad</strong>
        <span id="pnl-sanidad">0</span>
      </div>
      <div class="tarjeta" data-perm="seguridad">
        <strong>Registros del Velador (incluye visitas)</strong>
        <span id="pnl-seguridad">0</span>
      </div>
<div class="tarjeta" data-perm="potreros">
        <strong>Corrales abiertos por potrero</strong>
        <span id="pnl-corrales-abiertos">—</span>
      </div>
      <div class="tarjeta" data-perm="conta">
        <strong>Ingresos - Gastos (simple)</strong>
        <span id="pnl-conta">0 / 0</span>
      </div>
      <div class="tarjeta" style="grid-column: 1 / -1;">
        <strong>Pronóstico 7 días</strong>
        <div class="wx-wrap">
          <div class="wx-controls">
            <button type="button" class="btn-terciario" id="btnPermitirUbicacion">Permitir ubicación</button>
            <button type="button" class="btn-secundario" id="btnActualizarPronostico">Actualizar</button>
            <span class="wx-status" id="wxStatus">Sin ubicación aún.</span>
          </div>
          <div class="wx-grid" id="wx7">
            <div class="nota">Oprime <b>Permitir ubicación</b> para ver el pronóstico aquí.</div>
          <div class="wx-accum" id="wxAccum">Acumulado anual: —</div>
        </div>
        </div>
      </div>

    </div>
    <p class="nota">Resumen simple con base en la información capturada en los módulos.</p>
  </section>

  <!-- ANIMALES (incluye PESAJES) -->
  <section id="mod-animales" class="modulo">
    <h2>Animales</h2>
    <p>Altas, bajas y movimientos de animales. Incluye el sub-módulo de <b>Pesajes</b>.</p>

    <div class="subtabs" aria-label="Submódulos Animales">
      <button type="button" class="activo" data-sub="anim-reg">Registro</button>
      <button type="button" data-sub="anim-pes">Pesajes</button>
    </div>

    <!-- Registro -->
    <div id="sub-anim-reg" class="submodulo activo">
      <form id="form-animales">
        <div class="fila-dos">
          <div>
            <label>Arete oficial</label>
            <input name="areteOficial" required />
          </div>
          <div>
            <label>Arete rancho</label>
            <input name="areteRancho" />
          </div>
        </div>

        <div class="fila-tres">
          <div>
            <label>Sexo</label>
            <select name="sexo">
              <option value="">Selecciona…</option>
              <option value="Hembra">Hembra</option>
              <option value="Macho">Macho</option>
            </select>
          </div>
          <div>
            <label>Raza preponderante</label>
            <select name="razaPre" id="selRazaPre"></select>
          </div>
          <div>
            <label>Cruza 1 / Cruza 2 (opcional)</label>
            <div class="fila-dos">
              <select name="cruza1" id="selCruza1"></select>
              <select name="cruza2" id="selCruza2"></select>
              <div class="nota">Se llena automáticamente al capturar el arete (puedes corregirlo si hiciera falta).</div>
            </div>
          </div>
        </div>

        
<div class="fila-tres">
  <div>
    <label>Fecha de nacimiento</label>
    <input type="date" name="fechaNac" />
  </div>
  <div>
    <label>Grupo</label>
    <select name="grupo" id="selGrupoAnimales" required></select>
  </div>
  <div>
    <label>Agregar raza</label>
    <div class="fila-dos">
      <input id="txtNuevaRaza" placeholder="Ej. Simmental" />
      <button type="button" class="btn-terciario" id="btnAgregarRaza">Añadir</button>
    </div>
  </div>
</div>

<label>Observaciones</label>
<input name="obs" />
<div class="nota">La raza agregada se suma a los desplegables de raza y cruzas.</div>


        <div class="acciones">
          <button type="submit" class="btn-primario">Guardar animal</button>
          <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-animales')">Limpiar</button>
        </div>
      </form>

      <h3 style="margin-top:18px;">INVENTARIO</h3>
      <p class="nota">Aquí se muestran todas las cabezas registradas.</p>
      <div class="tarjeta" style="margin:12px 0; background:#fff; border:1px solid #e5e7eb;">
        <h4 style="margin:0 0 8px 0;">Cambiar grupo</h4>
        <p class="nota" style="margin:0 0 10px 0;">Selecciona un animal y asígnalo a un nuevo grupo. Se guardará la fecha del cambio.</p>
        <form id="form-cambiar-grupo" class="fila-dos" style="gap:12px; align-items:end;">
          <div>
            <label>Animal (arete oficial)</label>
            <select id="selAnimalCambioGrupo"></select>
          </div>
          <div>
            <label>Nuevo grupo</label>
            <select id="selNuevoGrupoAnimal"></select>
          </div>
          <div style="display:flex; gap:10px; align-items:end;">
            <button type="button" class="btn-terciario" id="btnCambiarGrupoAnimal">Guardar cambio</button>
          </div>
        </form>
      </div>


      <div class="lista" id="lista-animales"></div>
    </div>

    <!-- Pesajes -->
    <div id="sub-anim-pes" class="submodulo">
      <h3>Pesajes</h3>
      <p class="nota">Se divide en <b>Individual</b> y <b>Por grupo</b>, con cálculo de ganancia/pérdida respecto al último pesaje.</p>

      <details open>
        <summary>Pesaje individual</summary>
        <form id="form-pesaje-ind">
          <div class="fila-tres">
            <div>
              <label>Arete oficial</label>
              <input name="areteOficial" required />
            </div>
            <div>
              <label>Arete rancho</label>
              <input name="areteRancho" />
            </div>
            <div>
              <label>Sexo</label>
              <select name="sexo" id="selSexoPesInd">
                <option value="">Selecciona…</option>
                <option>Hembra</option>
                <option>Macho</option>
              </select>
            </div>
          </div>

          <div class="fila-tres">
            <div>
              <label>Fecha de pesaje</label>
              <input type="date" name="fecha" required />
            </div>
            <div>
              <label>Peso (kg)</label>
              <input type="number" step="0.1" name="peso" required />
            </div>
            <div>
              <label>Ubicación (Potrero / Corral)</label>
              <select name="ubicacion" id="selUbicInd"></select>
              <div class="nota">Selecciona la ubicación correspondiente.</div>
            </div>
          </div>

          <label>Observaciones</label>
          <textarea name="obs"></textarea>

          <div class="acciones">
            <button type="submit" class="btn-primario">Guardar pesaje individual</button>
            <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-pesaje-ind')">Limpiar</button>
          </div>
          <div class="nota" id="notaDeltaInd"></div>
        </form>

        <div class="lista" id="lista-pesaje-ind"></div>
      </details>

      <details>
        <summary>Pesaje por grupo</summary>
        <form id="form-pesaje-grupo">
          <div class="fila-tres">
            <div>
              <label>Grupo</label>
              <select name="grupo" id="selGrupoPesajes"></select>
            </div>
            <div>
              <label>Potrero</label>
              <select name="potrero" id="selPotreroPesajes"></select>
            </div>
            <div>
              <label>Corral (2 dígitos)</label>
              <input name="corral" placeholder="Ej. 01" maxlength="2" />
            </div>
          </div>

          <div class="fila-tres">
            <div>
              <label>Fecha</label>
              <input type="date" name="fecha" required />
            </div>
            <div>
              <label>No. de cabezas</label>
              <input type="number" step="1" name="cabezas" required />
            </div>
            <div>
              <label>Peso total (kg)</label>
              <input type="number" step="0.1" name="pesoTotal" required />
            </div>
          </div>

          <div class="fila-dos">
            <div>
              <label>Peso promedio (kg/cabeza)</label>
              <input type="number" step="0.1" name="pesoProm" readonly />
            </div>
            <div>
              <label>Ganancia / pérdida promedio vs último (kg/cabeza)</label>
              <input type="number" step="0.1" name="deltaProm" readonly />
            </div>
          </div>

          <label>Observaciones</label>
          <textarea name="obs"></textarea>

          <div class="acciones">
            <button type="submit" class="btn-primario">Guardar pesaje por grupo</button>
            <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-pesaje-grupo')">Limpiar</button>
          </div>
          <div class="nota" id="notaDeltaGrupo"></div>
        </form>

        <div class="lista" id="lista-pesaje-grupo"></div>
      </details>
    </div>
  </section>

  <!-- POTREROS Y CORRALES -->
  <section id="mod-potreros" class="modulo">
    <h2>Potreros y Corrales</h2>
    <p>Identificación de potreros por <b>letras</b> y corrales por <b>números (2 dígitos)</b>.</p>

    <div class="subtabs" aria-label="Submódulos Potreros">
      <button type="button" class="activo" data-sub="pot-potreros">Potreros</button>
      <button type="button" data-sub="pot-corrales">Corrales</button>
      <button type="button" data-sub="pot-supl">Suplementos</button>
    </div>

    <!-- Potreros -->
    <div id="sub-pot-potreros" class="submodulo activo">
      <form id="form-potreros">
        <div class="fila-tres">
          <div>
            <label>Potrero (letra)</label>
            <select name="letra" id="selPotreroLetra"></select>
          </div>
          <div>
            <label>Nombre opcional</label>
            <input name="nombre" placeholder="Ej. La Loma" />
          </div>
          <div>
            <label>Área estimada (m²) — calculada por puntos</label>
            <input name="areaM2" id="areaM2" readonly />
          </div>
        </div>

        <label>Descripción / notas</label>
        <textarea name="desc" placeholder="Sugerencia: tipo(s) de zacate, disponibilidad de agua (natural/bebederos), comederos portátiles, maleza, etc."></textarea>

        <details>
          <summary>Ubicación por GPS (para potreros no cercados)</summary>
          <p class="nota">Oprime <b>Agregar punto GPS</b> varias veces caminando el perímetro. Se dibuja el potrero y se calcula el área aproximada.</p>
          <div class="acciones">
            <button type="button" class="btn-terciario" id="btnPuntoGPS">Agregar punto GPS</button>
            <button type="button" class="btn-secundario" id="btnLimpiarGPS">Borrar puntos</button>
          </div>
          <div class="mapa-wrap">
            <canvas id="canvasPotrero" width="800" height="320"></canvas>
            <div class="puntos" id="listaPuntos">Sin puntos aún.</div>
          </div>
        </details>

        <div class="acciones">
          <button type="submit" class="btn-primario">Guardar potrero</button>
          <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-potreros'); limpiarPuntos();">Limpiar</button>
        </div>
      </form>

      <div class="lista" id="lista-potreros"></div>
    </div>

    <!-- Corrales -->
    <div id="sub-pot-corrales" class="submodulo">
      <form id="form-corrales">
        <div class="fila-tres">
          <div>
            <label>Corral (2 dígitos)</label>
            <input name="corralId" required maxlength="2" placeholder="Ej. 01" />
          </div>
          <div>
            <label>Potrero asociado (letra)</label>
            <select name="potrero" id="selPotreroCorrales"></select>
          </div>
          <div>
            <label>Grupo de animales</label>
            <select name="grupo" id="selGrupoCorrales"></select>
          </div>
        </div>

        
<div class="fila-tres">
  <div>
    <label>Área (m²) — calculada por GPS</label>
    <input name="areaM2" id="areaCorralM2" readonly />
  </div>
  <div>
    <label>Fecha / hora entrada</label>
    <input type="datetime-local" name="entrada" />
  </div>
  <div>
    <label>Fecha / hora salida</label>
    <input type="datetime-local" name="salida" />
  </div>
</div>

<details>
  <summary>Ubicación por GPS (polígono del corral)</summary>
  <p class="nota">Oprime <b>Agregar punto GPS</b> en las esquinas del corral. Se dibuja el polígono y se calcula el área en m². La imagen se guarda junto con el registro.</p>
  <div class="acciones">
    <button type="button" class="btn-terciario" id="btnPuntoGPSCorral">Agregar punto GPS</button>
    <button type="button" class="btn-secundario" id="btnLimpiarGPSCorral">Borrar puntos</button>
  </div>
  <div class="mapa-wrap">
    <canvas id="canvasCorral" width="800" height="260"></canvas>
    <div class="puntos" id="listaPuntosCorral">Sin puntos aún.</div>
  </div>
</details>

<div class="fila-tres">
  <div>
    <label>No. de animales en el corral</label>
    <input type="number" step="1" name="cabezas" required />
  </div>
  <div>
    <label>m² por animal</label>
    <input name="m2PorCabeza" readonly />
  </div>
  <div>
    <label>Índice de ocupación (cabezas/ha)</label>
    <input name="cabezasHa" readonly />
    <div class="nota">Cálculo: (cabezas × 10,000) / área(m²).</div>
  </div>
</div>


        <div class="fila-tres">
          <div>
            <label>Densidad del corral (cab/ha)</label>
            <input name="densidadAuto" readonly />
            <div class="nota">Se calcula automáticamente con el área (GPS) y el número de animales.</div>
          </div>
          <div>
            <label>Acceso a bebederos</label>
            <select name="bebedero">
              <option value="">No especificado</option>
              <option>Sí</option>
              <option>No</option>
            </select>
          </div>
          <div>
            <label>Acceso a comederos</label>
            <select name="comedero">
              <option value="">No especificado</option>
              <option>Sí</option>
              <option>No</option>
            </select>
          </div>
        </div>

        <label>Observaciones</label>
        <textarea name="obs" placeholder="Tipo de zacate o maleza disponible, condición del suelo, etc."></textarea>

        <div class="acciones">
          <button type="submit" class="btn-primario">Guardar corral</button>
          <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-corrales')">Limpiar</button>
          <button type="button" class="btn-terciario" id="btnAbrirSuplementos">Capturar suplemento</button>
        </div>
      </form>

      <div class="lista" id="lista-corrales"></div>
    </div>

    <!-- Suplementos -->
    <div id="sub-pot-supl" class="submodulo">
      <h3>Suplementos (recetas por zona / temporada)</h3>
      <p class="nota">Aquí se registran suplementos con ingredientes, proporciones, preparación y frecuencia, acorde a temporadas y clima.</p>

      <div class="acciones">
        <button type="button" class="btn-primario" id="btnNuevoSupl">Nuevo suplemento</button>
        <button type="button" class="btn-secundario" id="btnBorrarSupl">Borrar todos (solo suplementos)</button>
      </div>

      <div class="lista" id="lista-supl"></div>

      <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;">
      <h4>Registro de suministro por corral</h4>
      <form id="form-supl-suministro">
        <div class="fila-tres">
          <div>
            <label>Fecha</label>
            <input type="date" name="fecha" required />
          </div>
          <div>
            <label>Potrero</label>
            <select name="potrero" id="selPotreroSupl"></select>
          </div>
          <div>
            <label>Corral</label>
            <select name="corralId" id="selCorralSupl"></select>
          </div>
        </div>

        <div class="fila-tres">
          <div>
            <label>No. de cabezas (auto desde el corral)</label>
            <input name="cabezas" id="suplCabezas" readonly />
          </div>
          <div>
            <label>Suplemento (catálogo)</label>
            <select name="suplClave" id="selSuplCatalogo" required></select>
          </div>
          <div>
            <label>Uso / objetivo</label>
            <input name="uso" placeholder="Ej. Engorda, lactancia, mineral, etc." />
          </div>
        </div>

        <div class="fila-tres">
          <div>
            <label>Cantidad por cabeza</label>
            <input type="number" step="0.01" name="cantidad" required />
          </div>
          <div>
            <label>Unidad</label>
            <select name="unidad">
              <option>kg</option>
              <option>g</option>
              <option>ml</option>
              <option>l</option>
            </select>
          </div>
          <div>
            <label>Frecuencia</label>
            <input name="frecuencia" placeholder="Ej. Diario, 3 veces/semana" />
          </div>
        </div>

        <label>Observaciones</label>
        <textarea name="obs" placeholder="Notas de suministro, temporada/clima, etc."></textarea>

        <div class="acciones">
          <button type="submit" class="btn-primario">Guardar suministro</button>
          <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-supl-suministro')">Limpiar</button>
        </div>
      </form>

      <h4 style="margin-top:16px;">Registros de suministro (por potrero)</h4>
      <div class="lista" id="lista-supl-suministros"></div>

    </div>
  </section>

  <!-- REPRODUCCIÓN Y PARTOS -->
  <section id="mod-repro" class="modulo">
    <h2>Reproducción y partos</h2>
    <p>Seguimiento de empadres, gestaciones y partos. Incluye cruza del vientre y del toro (preponderante + cruza 1/2) para estimar cruza de la cría.</p>

    <form id="form-repro">
      <h3>Hembra (vientre)</h3>
      <div class="fila-tres">
        <div>
          <label>Arete hembra (vientre)</label>
          <input name="vientre" required />
        </div>
        <div>
          <label>Raza preponderante</label>
          <select name="razaH" class="selRaza"></select>
        </div>
        <div>
          <label>Cruza 1 / Cruza 2</label>
          <div class="fila-dos">
            <select name="cruzaH1" class="selRaza"></select>
            <select name="cruzaH2" class="selRaza"></select>
          </div>
        </div>
      </div>

      <h3>Macho (toro)</h3>
      <div class="fila-tres">
        <div>
          <label>Arete / nombre del toro</label>
          <input name="toro" />
        </div>
        <div>
          <label>Raza preponderante</label>
          <select name="razaM" class="selRaza"></select>
        </div>
        <div>
          <label>Cruza 1 / Cruza 2</label>
          <div class="fila-dos">
            <select name="cruzaM1" class="selRaza"></select>
            <select name="cruzaM2" class="selRaza"></select>
          </div>
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Peso estimado vientre (kg)</label>
          <input type="number" step="0.1" name="pesoVientre" />
        </div>
        <div>
          <label>Peso estimado toro (kg)</label>
          <input type="number" step="0.1" name="pesoToro" />
        </div>
        <div>
          <label>Cruza estimada de la cría</label>
          <input name="cruzaCria" readonly />
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Fecha de empadre</label>
          <input type="date" name="fechaEmp" />
        </div>
        <div>
          <label>Fecha probable de parición</label>
          <input type="date" name="fechaProb" />
          <div class="nota">Se puede calcular automático con gestación típica (283 días).</div>
        </div>
        <div style="display:flex; align-items:end; gap:6px;">
          <button type="button" class="btn-terciario" id="btnCalcularProb">Calcular (283 días)</button>
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Fecha de parto</label>
          <input type="date" name="fechaParto" />
        </div>
        <div>
          <label>Sexo de la cría</label>
          <select name="sexoCria">
            <option value="">Selecciona…</option>
            <option>Hembra</option>
            <option>Macho</option>
          </select>
        </div>
        <div>
          <label>Peso al nacer (kg)</label>
          <input type="number" step="0.1" name="pesoCria" />
        </div>
      </div>


      <div class="fila-dos">
        <div>
          <label>Cruza preponderante (hembra)</label>
          <input name="cruzaPreH" readonly />
        </div>
        <div>
          <label>Cruza preponderante (macho)</label>
          <input name="cruzaPreM" readonly />
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Calostro — toma</label>
          <select name="calostroNivel">
            <option value="">Selecciona…</option>
            <option>Normal</option>
            <option>Regular</option>
            <option>Baja</option>
          </select>
        </div>
        <div>
          <label>Calostro complementario</label>
          <select name="calostroComp">
            <option value="">Selecciona…</option>
            <option>Sí</option>
            <option>No</option>
          </select>
        </div>
        <div>
          <label>Problema de salud al nacer</label>
          <select name="saludCat" id="selSaludNac">
            <option value="">Ninguno</option>
            <option>Digestivo</option>
            <option>Respiratorio</option>
            <option>Infeccioso</option>
            <option>Motriz</option>
            <option>Ocular</option>
            <option>Otro</option>
          </select>
        </div>
      </div>

      <div id="wrapSaludOtro" style="display:none;">
        <label>Especifica enfermedad</label>
        <input name="saludOtro" placeholder="Describe la enfermedad" />
      </div>

      <label>Observaciones (condiciones del parto y estado físico del vientre y de la cría)</label>
      <textarea name="obs"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar evento</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-repro')">Limpiar</button>
      </div>
    </form>

    <details>
      <summary>Actividades sugeridas (Reproducción y partos)</summary>
      <ul>
        <li>Vigilancia de vientres en gestación.</li>
        <li>Atención al parto y a la cría (calostro, primeras horas).</li>
        <li>Registro de problemas y seguimiento.</li>
      </ul>
    </details>

    <div class="lista" id="lista-repro"></div>
  </section>

  <!-- SANIDAD -->
  <section id="mod-sanidad" class="modulo">
    <h2>Sanidad</h2>
    <p>Eventos sanitarios: enfermedades, tratamientos y vacunación.</p>
    <form id="form-sanidad">
      <div class="fila-dos">
        <div>
          <label>Arete oficial</label>
          <input name="arete" />
        </div>
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" />
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Tipo de evento</label>
          <select name="tipo">
            <option value="">Selecciona…</option>
            <option>Preventivo (vacuna)</option>
            <option>Correctivo (enfermedad)</option>
          </select>
        </div>
        <div>
          <label>Enfermedad / motivo</label>
          <select name="enfermedadCat" id="selEnfSan">
            <option value="">Selecciona…</option>
            <option>Digestivo</option>
            <option>Respiratorio</option>
            <option>Infeccioso</option>
            <option>Motriz</option>
            <option>Ocular</option>
            <option>Otro</option>
          </select>

          <div id="wrapEnfSanOtro" style="display:none; margin-top:8px;">
            <label>Especifica enfermedad</label>
            <input name="enfermedadOtro" placeholder="Ej. Anaplasmosis, Brucelosis…" />
          </div>
</div>
        <div>
          <label>Temperatura (°C)</label>
          <input type="number" step="0.1" name="temp" />
        </div>
      </div>

      <label>Tratamiento / vacuna aplicada</label>
      <input name="tratamiento" />

      <label>Observaciones</label>
      <textarea name="obs"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar sanidad</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-sanidad')">Limpiar</button>
      </div>
    </form>

    <div class="lista" id="lista-sanidad"></div>
  </section>
<!-- CONTABILIDAD -->
  <section id="mod-conta" class="modulo">
    <h2>Contabilidad (flujos simples)</h2>
    <p>Registro básico de ingresos y gastos del rancho.</p>
    <form id="form-conta">
      <div class="fila-tres">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" />
        </div>
        <div>
          <label>Tipo</label>
          <select name="tipo">
            <option value="">Selecciona…</option>
            <option>Ingreso</option>
            <option>Gasto</option>
          </select>
        </div>
        <div>
          <label>Monto</label>
          <input type="number" step="0.01" name="monto" />
        </div>
      </div>

      <label>Cuenta / concepto</label>
      <input name="cuenta" placeholder="Ej. Ventas, Suplementos, Mano de obra…" />

      <label>Descripción</label>
      <textarea name="desc"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar movimiento</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-conta')">Limpiar</button>
      </div>
    </form>

    <div class="lista" id="lista-conta"></div>
  </section>

  <!-- REGISTROS DEL VELADOR (incluye visitas) -->
  <section id="mod-seguridad" class="modulo">
    <h2>Registros del Velador</h2>
    <p>Registro de visitas, vehículos y bitácora diaria del velador.</p>

    <h3>Registro de visitantes</h3>
    <form id="form-visitas">
      <div class="fila-tres">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" />
        </div>
        <div>
          <label>Hora llegada</label>
          <input type="time" name="horaLlegada" />
        </div>
        <div>
          <label>Hora salida</label>
          <input type="time" name="horaSalida" />
        </div>
      </div>

      <div class="fila-dos">
        <div>
          <label>Nombre del visitante / grupo</label>
          <input name="nombre" />
        </div>
        <div>
          <label>Asunto / a quién busca</label>
          <input name="asunto" />
        </div>
      </div>

      <div class="fila-dos">
        <div>
          <label>Vehículo</label>
          <input name="vehiculo" placeholder="Tipo de vehículo" />
        </div>
        <div>
          <label>Placas</label>
          <input name="placas" />
        </div>
      </div>

      <label>Observaciones</label>
      <textarea name="obs"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar visita</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-visitas')">Limpiar</button>
      </div>
    </form>

    <h3>Bitácora diaria del velador</h3>
    <form id="form-bitacora">
      <div class="fila-dos">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" />
        </div>
        <div>
          <label>Hora</label>
          <input type="time" name="hora" />
        </div>
      </div>

      <label>Descripción de hechos / observaciones</label>
      <textarea name="evento" placeholder="Eventos relevantes del día/noche"></textarea>

      <label>Involucrados (personas, animales, clima, otros)</label>
      <textarea name="involucrados"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar registro</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-bitacora')">Limpiar</button>
      </div>
    </form>

    <div class="lista" id="lista-seguridad"></div>
  </section>

  <!-- MAQUINARIA Y EQUIPO -->
  <section id="mod-maquinaria" class="modulo">
    <h2>Maquinaria, equipo y herramientas</h2>
    <p>Inventario y mantenimiento básico de maquinaria, equipo, instalaciones y herramientas.</p>

    <form id="form-maquinaria">
      <div class="fila-tres">
        <div>
          <label>Tipo de activo</label>
          <select name="tipo">
            <option value="">Selecciona…</option>
            <option>Maquinaria</option>
            <option>Equipo</option>
            <option>Herramienta</option>
            <option>Instalación</option>
          </select>
        </div>
        <div>
          <label>Cantidad</label>
          <input type="number" step="1" name="cantidad" />
        </div>
        <div>
          <label>Vida útil (años estimados)</label>
          <input type="number" step="1" name="vida" />
        </div>
      </div>

      <label>Descripción del activo</label>
      <input name="desc" placeholder="Ej. Tractor 80 HP, Bomba de agua, etc." />

      <div class="fila-dos">
        <div>
          <label>Marca / Modelo</label>
          <input name="marcaModelo" />
        </div>
        <div>
          <label>Número de serie (opcional)</label>
          <input name="serie" />
        </div>
      </div>

      <div class="fila-tres">
        <div>
          <label>Fecha de adquisición</label>
          <input type="date" name="fechaAdq" />
        </div>
        <div>
          <label>Último mantenimiento</label>
          <input type="date" name="fechaMant" />
        </div>
        <div>
          <label>Costo del último mantenimiento</label>
          <input type="number" step="0.01" name="costoMant" />
        </div>
      </div>

      <label>Descripción del mantenimiento / taller / mecánico</label>
      <textarea name="detMant"></textarea>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar activo</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-maquinaria')">Limpiar</button>
      </div>
    </form>

    <div class="lista" id="lista-maquinaria"></div>
  </section>

  <!-- ACTIVIDADES -->
  <section id="mod-actividades" class="modulo">
    <h2>Actividades y tareas</h2>
    <p>Asigna tareas y da seguimiento. Vaquero/Auxiliar/Otro solo ven lo que se les asigna y pueden marcarlo como completado.</p>

    <div class="tarjeta" id="actAdminBox" style="background:#fff;border:1px solid #e5e7eb;">
      <div class="nota" style="margin-bottom:10px;"><b>Solo Propietario/Gerente/Supervisor</b> pueden registrar y asignar tareas.</div>

      <form id="form-actividades">
        <div class="fila-dos">
          <div>
            <label>Módulo</label>
            <select name="modulo">
              <option value="">Selecciona…</option>
              <option>Animales</option>
              <option>Pesajes</option>
              <option>Potreros</option>
              <option>Corrales</option>
              <option>Reproducción y partos</option>
              <option>Sanidad</option>
              <option>Contabilidad</option>
              <option>Registros del Velador</option>
              <option>Maquinaria y equipo</option>
              <option>Suplementos</option>
            </select>
          </div>
          <div>
            <label>Asignado a</label>
            <select name="asignadoA" id="selAsignadoA">
              <option value="">Selecciona…</option>
            </select>
          </div>
        </div>

        <label>Descripción de tarea</label>
        <textarea name="descripcionTarea" placeholder="Describe la tarea. Tip: puedes poner varias líneas (una tarea por línea)."></textarea>

        <div class="fila-dos">
          <div>
            <label>Fecha de inicio</label>
            <input type="date" name="fechaInicio" />
          </div>
          <div>
            <label>Periodicidad</label>
            <select name="periodicidad">
              <option value="">Selecciona…</option>
              <option>Diaria</option>
              <option>Terciada</option>
              <option>Semanal</option>
              <option>Quincenal</option>
              <option>Mensual</option>
              <option>Trimestral</option>
              <option>Semestral</option>
              <option>Anual</option>
              <option>Eventual</option>
            </select>
          </div>
        </div>

        <label>Notas</label>
        <input name="notas" placeholder="Opcional" />

        <div class="acciones">
          <button type="submit" class="btn-primario">Guardar tarea</button>
          <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-actividades')">Limpiar</button>
        </div>
      </form>
    </div>

    <div class="tarjeta" id="actTareasBox" style="background:#fff;border:1px solid #e5e7eb;margin-top:12px;">
      <h3 style="margin:0 0 8px;">Tareas pendientes</h3>
      <div id="listaTareasPend" class="nota">Sin tareas.</div>

      <h3 style="margin:14px 0 8px;">Tareas completadas</h3>
      <div id="listaTareasComp" class="nota">Sin tareas.</div>
    </div>
  </section>

  <!-- REPORTES -->
  <section id="mod-reportes" class="modulo">
    <h2>Reportes</h2>
    <p>Resumen simple de registros por módulo (solo conteos, por ahora).</p>

    <table class="tabla-simple" style="width:100%; border-collapse: collapse; font-size: 12px;">
      <thead>
        <tr>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Módulo</th>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Registros</th>
        </tr>
      </thead>
      <tbody>
        <tr data-rep="animales"><td style="padding:6px;">Animales</td><td style="padding:6px;" id="rep-animales">0</td></tr>
        <tr data-rep="pesajes"><td style="padding:6px;">Pesajes</td><td style="padding:6px;" id="rep-pesajes">0</td></tr>
        <tr data-rep="repro"><td style="padding:6px;">Reproducción y partos</td><td style="padding:6px;" id="rep-repro">0</td></tr>
        <tr data-rep="sanidad"><td style="padding:6px;">Sanidad</td><td style="padding:6px;" id="rep-sanidad">0</td></tr>
<tr data-rep="conta"><td style="padding:6px;">Contabilidad</td><td style="padding:6px;" id="rep-conta">0</td></tr>
        <tr data-rep="seguridad"><td style="padding:6px;">Registros del Velador</td><td style="padding:6px;" id="rep-seguridad">0</td></tr>
        <tr data-rep="maquinaria"><td style="padding:6px;">Maquinaria y equipo</td><td style="padding:6px;" id="rep-maquinaria">0</td></tr>
        <tr data-rep="actividades"><td style="padding:6px;">Actividades</td><td style="padding:6px;" id="rep-actividades">0</td></tr>
        <tr data-rep="potreros"><td style="padding:6px;">Potreros</td><td style="padding:6px;" id="rep-potreros">0</td></tr>
        <tr data-rep="corrales"><td style="padding:6px;">Corrales</td><td style="padding:6px;" id="rep-corrales">0</td></tr>
        <tr data-rep="supl"><td style="padding:6px;">Suplementos</td><td style="padding:6px;" id="rep-supl">0</td></tr>
      </tbody>
    </table>

    
    <details class="tarjeta" style="margin-top:14px; background:#fff; border:1px solid #e5e7eb;">
      <summary><b>Permisos de reportes por rol</b></summary>
      <p class="nota" style="margin:8px 0 10px 0;">Define qué filas aparecen en <b>Reportes</b> según el rol del usuario.</p>

      <div class="fila-dos" style="gap:12px; align-items:end;">
        <div>
          <label>Rol</label>
          <select id="selRolReportes"></select>
        </div>
        <div style="display:flex; gap:10px;">
          <button type="button" class="btn-terciario" id="btnGuardarPermReportes">Guardar permisos</button>
          <button type="button" class="btn-secundario" id="btnRestaurarPermReportes">Restaurar default</button>
        </div>
      </div>

      <div id="chkPermReportes" class="tarjeta" style="margin-top:10px; background:#f9fafb; border:1px solid #e5e7eb;"></div>
    </details>

    <p class="nota">En futuras versiones se pueden agregar KPI detallados.</p>
  </section>

  <!-- PERFIL DEL RANCHO -->
  <section id="mod-config" class="modulo">
    <h2>Perfil del rancho</h2>
    <p>Datos generales del rancho y capacidad estimada.</p>

    <form id="form-config">
      <label>Nombre del rancho</label>
      <input name="nombreRancho" />

      <label>Propietario</label>
      <input name="propietario" />

      <label>Tenencia del rancho</label>
      <select name="tenencia">
        <option value="">Selecciona…</option>
        <option>Propiedad</option>
        <option>En arrendamiento</option>
        <option>Derechos ejidales</option>
        <option>Otros</option>
      </select>

      <div class="fila-tres">
        <div>
          <label>Extensión total (ha)</label>
          <input type="number" step="0.01" name="haTotales" />
        </div>
        <div>
          <label>Ha de agostadero</label>
          <input type="number" step="0.01" name="haAgostadero" />
        </div>
        <div>
          <label>Ha de pastos</label>
          <input type="number" step="0.01" name="haPastos" />
        </div>
      </div>

      <div class="fila-dos">
        <div>
          <label>Capacidad estimada de vientres y crías al año</label>
          <input type="number" step="1" name="capacidad" />
        </div>
        <div>
          <label>Animales actuales</label>
          <input type="number" step="1" name="animalesActuales" />
        </div>
      </div>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar perfil</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-config')">Limpiar</button>
      </div>
    </form>

    <p class="nota">Estos datos se usan como referencia general y pueden ajustarse en cualquier momento.</p>

    <hr style="margin:18px 0; border:none; border-top:1px solid #e5e7eb;">
    <h3>Usuarios y accesos</h3>
    <p class="nota">Crea usuarios (vaqueros, supervisores, auxiliares) y asigna qué módulos pueden ver.</p>

    <form id="form-usuarios">
      <div class="fila-tres">
        <div>
          <label>Nombre</label>
          <input name="nombre" required />
        </div>
        <div>
          <label>Rol</label>
          <select name="rol" required>
            <option value="">Selecciona…</option>
            <option>Propietario</option>
            <option>Gerente</option>
            <option>Supervisor</option>
            <option>Vaquero</option>
            <option>Auxiliar</option>
            <option>Otro</option>
          </select>
            <div id="rolOtroWrap" style="display:none; margin-top:6px;">
              <label>Nombre del rol (Otro)</label>
              <input name="rolOtro" placeholder="Ej. Veterinario, Chofer, Administrativo…" />
            </div>
        </div>
        <div>
          <label>Estado</label>
          <select name="activo">
            <option>Activo</option>
            <option>Inactivo</option>
          </select>
        </div>
      </div>

      <label>Acceso a módulos</label>
      <div class="tarjeta" style="background:#fff;border:1px solid #e5e7eb;">
        <div class="nota">Marca los módulos permitidos para este usuario.</div>
        <div id="chkPermisos"></div>
      </div>

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar usuario</button>
        <button type="button" class="btn-secundario" onclick="limpiarFormulario('form-usuarios')">Limpiar</button>
      </div>
    </form>

    <div class="lista" id="lista-usuarios"></div>

  </section>
</main>

<!-- MODAL: Nuevo suplemento -->
<div class="modal" id="modalSupl">
  <div class="panel">
    <header>
      <h2 style="margin:0;">Suplementos</h2>
      <p class="nota" style="margin:4px 0 0 0;">Ingredientes, proporciones, preparación y frecuencia.</p>
    </header>

    <form id="form-supl">
      <div class="fila-tres">
        <div>
          <label>Clave</label>
          <input name="clave" required placeholder="Ej. SUP-INV-01" />
        </div>
        <div>
          <label>Nombre del suplemento</label>
          <input name="nombre" required placeholder="Ej. Suplemento de invierno" />
        </div>
        <div>
          <label>Temporada / clima</label>
          <input name="temporada" placeholder="Ej. Frío, Sequía, Lluvias…" />
        </div>
      </div>

      <label>Uso / objetivo del suplemento</label>
      <input name="uso" placeholder="Ej. Engorda, mineralización, lactancia, recuperación…" />

      <label>Ingredientes + %</label>
      <div class="nota">Agrega los ingredientes y su porcentaje de participación. (Sugerencia: que sumen 100%).</div>
      <div id="ingWrap"></div>
      <div class="acciones">
        <button type="button" class="btn-terciario" id="btnAddIng">Agregar ingrediente</button>
        <button type="button" class="btn-secundario" id="btnClearIng">Borrar ingredientes</button>
      </div>
      <input type="hidden" name="ingredientesJSON" id="ingredientesJSON" />

      <label>Forma de preparación</label>
      <textarea name="preparacion" placeholder="Pasos para preparar"></textarea>

      <label>Frecuencia de suministro</label>
      <input name="frecuencia" placeholder="Ej. Diario, 3 veces/semana, etc." />

      <div class="acciones">
        <button type="submit" class="btn-primario">Guardar suplemento</button>
        <button type="button" class="btn-secundario" id="btnCerrarSupl">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Ajuste dinámico para que la barra de navegación quede justo debajo del header
  (function(){
    function setHeaderH(){
      const h = document.querySelector('header');
      if(!h) return;
      document.documentElement.style.setProperty('--headerH', h.offsetHeight + 'px');
    }
    window.addEventListener('load', setHeaderH);
    window.addEventListener('resize', ()=>{
      clearTimeout(window.__hdrT);
      window.__hdrT = setTimeout(setHeaderH, 150);
    });
    setTimeout(setHeaderH, 0);
  })();

  // ======================
  // Utilidades localStorage
  // ======================
  function getData(key) {
    try {
      return JSON.parse(localStorage.getItem(key)) || [];
    } catch (e) {
      return [];
    }
  }
  function setData(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  

  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
  }
// ======================
  // Listas maestras (razas, grupos, potreros)
  // ======================
  const razasBase = [
    "Charolais","Angus","Pardo Suizo","Brahman","Holstein","Santa Gertrudis",
    "Limousin","Wagyu","Akaushi","Nelore","Brafor","Tropicarne","Hereford",
    "Beefmaster","Brangus"
  ];

  const gruposBase = [
    "En espera",
    "Vientre en desarrollo",
    "Vientre en empadre",
    "Vientre en gestación",
    "Vientre en parición",
    "Vientre amamantando",
    "Vientre vacío",
    "Cría en desarrollo",
    "Ganado estabulado",
    "Toro"
  ];

  function getRazas() {
    const extra = getData('pecuario_razas_extra');
    const all = [...razasBase, ...extra].filter(Boolean);
    // dedupe
    return Array.from(new Set(all.map(r => (r||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'es'));
  }

  function llenarSelect(selectEl, opciones, withBlank=true, blankText="Selecciona…") {
    if (!selectEl) return;
    selectEl.innerHTML = '';
    if (withBlank) {
      const o = document.createElement('option');
      o.value = '';
      o.textContent = blankText;
      selectEl.appendChild(o);
    }
    opciones.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
  }

  function llenarPotreros(selectEl) {
    const letras = [];
    for (let i=0;i<26;i++) letras.push(String.fromCharCode(65+i));
    llenarSelect(selectEl, letras, true, "Selecciona…");
  }

  function refrescarRazasEnUI() {
    const razas = getRazas();
    llenarSelect(document.getElementById('selRazaPre'), razas);
    llenarSelect(document.getElementById('selCruza1'), razas, true, "Cruza 1…");
    llenarSelect(document.getElementById('selCruza2'), razas, true, "Cruza 2…");

    // Repro: todos los selects con clase selRaza
    document.querySelectorAll('select.selRaza').forEach(sel => llenarSelect(sel, razas));
  }

  function refrescarGruposEnUI() {
    llenarSelect(document.getElementById('selGrupoAnimales'), gruposBase);
    llenarSelect(document.getElementById('selGrupoPesajes'), gruposBase);
    llenarSelect(document.getElementById('selGrupoCorrales'), gruposBase);
  }

    // ======================
  // Inventario: cambio de grupo
  // ======================
  function refrescarSelectorAnimalesCambioGrupo(){
    const selA = document.getElementById('selAnimalCambioGrupo');
    const selG = document.getElementById('selNuevoGrupoAnimal');
    if (!selA || !selG) return;

    // llenar grupos
    llenarSelect(selG, gruposBase, true, "Selecciona…");

    // llenar animales (último registro por arete)
    const lista = getData('pecuario_animales');
    const map = {};
    lista.forEach((a, idx)=>{
      const k = (a.areteOficial||'').trim();
      if (!k) return;
      map[k] = { ...a, _idx: idx }; // nos quedamos con el más reciente
    });
    const keys = Object.keys(map).sort();
    selA.innerHTML = '';
    if (!keys.length){
      const o=document.createElement('option');
      o.value='';
      o.textContent='Sin animales registrados';
      selA.appendChild(o);
      return;
    }
    keys.forEach(k=>{
      const a = map[k];
      const o=document.createElement('option');
      o.value = k;
      o.textContent = `${k}  |  Rancho: ${a.areteRancho||'-'}  |  Grupo: ${a.grupo||'-'}  |  Sexo: ${a.sexo||'-'}`;
      selA.appendChild(o);
    });
  }

  function cambiarGrupoAnimal(areteOficial, nuevoGrupo){
    const lista = getData('pecuario_animales');
    // buscar el más reciente
    let idx = -1;
    for (let i=lista.length-1; i>=0; i--){
      if ((lista[i].areteOficial||'') === (areteOficial||'')) { idx = i; break; }
    }
    if (idx < 0) return false;

    const a = lista[idx];
    const antes = a.grupo || '';
    const ahora = nuevoGrupo || '';
    if (!ahora) { alert('Selecciona un grupo.'); return false; }
    if (antes === ahora) { alert('El animal ya está en ese grupo.'); return false; }

    const fecha = new Date().toISOString();
    if (!Array.isArray(a._histGrupo)) a._histGrupo = [];
    a._histGrupo.push({ fecha, de: antes, a: ahora });
    a._fechaUltCambioGrupo = fecha;
    a.grupo = ahora;

    lista[idx] = a;
    setData('pecuario_animales', lista);

    // refrescar UI
    pintarLista('pecuario_animales','lista-animales', (x)=> `Arete ${x.areteOficial || '-'} | Sexo: ${x.sexo || '-'} | Raza: ${x.razaPre || '-'} | Cruza: ${[x.cruza1,x.cruza2].filter(Boolean).join(' / ') || '-'} | Grupo: ${x.grupo || '-'}`);
    actualizarPanel();
    actualizarReportes();
    refrescarSelectorAnimalesCambioGrupo();
    alert('Grupo actualizado.');
    return true;
  }

  // ======================
  // Reportes: permisos por rol
  // ======================
  const ROLES = ["Propietario","Gerente","Supervisor","Vaquero","Auxiliar","Otro"];
  const REPORT_ITEMS = [
    {key:"animales", label:"Animales"},
    {key:"pesajes", label:"Pesajes"},
    {key:"repro", label:"Reproducción y partos"},
    {key:"sanidad", label:"Sanidad"},    {key:"conta", label:"Contabilidad"},
    {key:"seguridad", label:"Registros del Velador"},
    {key:"maquinaria", label:"Maquinaria y equipo"},
    {key:"actividades", label:"Actividades"},
    {key:"potreros", label:"Potreros"},
    {key:"corrales", label:"Corrales"},
    {key:"supl", label:"Suplementos"}
  ];

  function getPermReportesRoles(){
    try { return JSON.parse(localStorage.getItem('pecuario_reportes_roles') || '{}'); }
    catch(e){ return {}; }
  }
  function setPermReportesRoles(obj){
    localStorage.setItem('pecuario_reportes_roles', JSON.stringify(obj||{}));
  }
  function defaultPermReportes(){
    const o = {};
    ROLES.forEach(r=> o[r] = REPORT_ITEMS.map(x=>x.key));
    return o;
  }

  function renderPermReportesUI(){
    const selRol = document.getElementById('selRolReportes');
    const cont = document.getElementById('chkPermReportes');
    const btnSave = document.getElementById('btnGuardarPermReportes');
    const btnReset = document.getElementById('btnRestaurarPermReportes');
    if (!selRol || !cont) return;

    // roles
    selRol.innerHTML = '';
    ROLES.forEach(r=>{
      const o=document.createElement('option'); o.value=r; o.textContent=r; selRol.appendChild(o);
    });

    // inicializar default si no existe
    let perms = getPermReportesRoles();
    if (!Object.keys(perms).length){
      perms = defaultPermReportes();
      setPermReportesRoles(perms);
    }

    
    // Migración: si existía 'Consulta', pásalo a 'Otro'
    if (perms['Consulta'] && !perms['Otro']) {
      perms['Otro'] = perms['Consulta'];
      delete perms['Consulta'];
      setPermReportesRoles(perms);
    }
const renderChecks = ()=>{
      const rol = selRol.value;
      const allowed = new Set((perms[rol] || REPORT_ITEMS.map(x=>x.key)));
      cont.innerHTML = '<div class="nota" style="margin-bottom:8px;">Selecciona qué filas aparecerán para este rol.</div>';
      const wrap = document.createElement('div');
      wrap.style.display='grid';
      wrap.style.gridTemplateColumns='repeat(auto-fit, minmax(190px, 1fr))';
      wrap.style.gap='8px';

      REPORT_ITEMS.forEach(it=>{
        const lab=document.createElement('label');
        lab.style.display='flex';
        lab.style.gap='8px';
        lab.style.alignItems='center';
        lab.style.padding='8px';
        lab.style.border='1px solid #e5e7eb';
        lab.style.borderRadius='12px';
        lab.style.background='#fff';

        const chk=document.createElement('input');
        chk.type='checkbox';
        chk.id='repperm_'+it.key;
        chk.checked = allowed.has(it.key);

        const span=document.createElement('span');
        span.textContent = it.label;

        lab.appendChild(chk);
        lab.appendChild(span);
        wrap.appendChild(lab);
      });
      cont.appendChild(wrap);
    };

    selRol.addEventListener('change', renderChecks);
    renderChecks();

    if (btnSave){
      btnSave.addEventListener('click', ()=>{
        const rol = selRol.value;
        const selected = [];
        REPORT_ITEMS.forEach(it=>{
          const chk = document.getElementById('repperm_'+it.key);
          if (chk && chk.checked) selected.push(it.key);
        });
        perms[rol] = selected;
        setPermReportesRoles(perms);
        aplicarPermisosReportes();
        alert('Permisos de reportes guardados.');
      });
    }

    if (btnReset){
      btnReset.addEventListener('click', ()=>{
        perms = defaultPermReportes();
        setPermReportesRoles(perms);
        renderChecks();
        aplicarPermisosReportes();
        alert('Permisos restaurados.');
      });
    }
  }

  function rolActual(){
    const nombre = localStorage.getItem('pecuario_usuario_actual') || '';
    const u = getUsuarios().find(x=>x.nombre===nombre) || null;
    return u ? (u.rolBase || u.rol || '') : '';
  }

  function aplicarPermisosReportes(){
    const rol = rolActual();
    let perms = getPermReportesRoles();
    if (!Object.keys(perms).length) perms = defaultPermReportes();
    const allowed = new Set(perms[rol] || REPORT_ITEMS.map(x=>x.key));
    document.querySelectorAll('#mod-reportes tr[data-rep]').forEach(tr=>{
      const k = tr.getAttribute('data-rep');
      tr.style.display = allowed.has(k) ? '' : 'none';
    });
  }

function refrescarPotrerosEnUI() {
    llenarPotreros(document.getElementById('selPotreroLetra'));
    llenarPotreros(document.getElementById('selPotreroPesajes'));
    llenarPotreros(document.getElementById('selPotreroCorrales'));
    llenarPotreros(document.getElementById('selPotreroSupl'));
    // ubicaciones para pesaje individual
    if (typeof refrescarUbicacionesEnUI === 'function') refrescarUbicacionesEnUI();
    if (typeof refrescarCorralesEnUI === 'function') refrescarCorralesEnUI();
  }

  // ======================
  // Portada
  // ======================
  (function portadaInit(){
    const portada = document.getElementById('portada');
    const btnEntrar = document.getElementById('btnEntrar');
    const btnCerrarMarca = document.getElementById('btnCerrarMarca');
    const wm = portada.querySelector('.watermark');

    btnEntrar.addEventListener('click', ()=> {
      portada.style.display = 'none';
    });
    btnCerrarMarca.addEventListener('click', ()=> {
      if (wm) wm.style.display = (wm.style.display === 'none') ? 'grid' : 'none';
    });
  })();

  // ======================
  // Navegación principal
  // ======================
  const navBtns = document.querySelectorAll('nav button');
  const modulos = document.querySelectorAll('section.modulo');

  navBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-modulo');
      navBtns.forEach(b => b.classList.remove('activo'));
      btn.classList.add('activo');
      modulos.forEach(sec => sec.classList.remove('activo'));
      const destino = document.getElementById('mod-' + target);
      if (destino) destino.classList.add('activo');
      actualizarPanel();
      actualizarReportes();
    });
  });

  // ======================
  // Subtabs (Animales / Potreros)
  // ======================
  function initSubtabs(scopeEl) {
    if (!scopeEl) return;
    const btns = scopeEl.querySelectorAll('.subtabs button');
    btns.forEach(b => {
      b.addEventListener('click', () => {
        const sub = b.getAttribute('data-sub');
        btns.forEach(x => x.classList.remove('activo'));
        b.classList.add('activo');

        scopeEl.querySelectorAll('.submodulo').forEach(sm => sm.classList.remove('activo'));
        const target = scopeEl.querySelector('#sub-' + sub);
        if (target) target.classList.add('activo');
      });
    });
  }
  initSubtabs(document.getElementById('mod-animales'));
  initSubtabs(document.getElementById('mod-potreros'));

  // ======================
  // Formularios base
  // ======================
  function limpiarFormulario(idForm) {
    const form = document.getElementById(idForm);
    if (form) form.reset();
  }

  function manejarFormulario(idForm, storageKey, idLista, formatearLinea, extraCallback, validateCallback) {
    const form = document.getElementById(idForm);
    if (!form) return;
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const datos = new FormData(form);
      const obj = {};
      datos.forEach((val, key) => { obj[key] = val; });
      if (typeof validateCallback === 'function') { if (validateCallback(obj, form) === false) return; }

      const lista = getData(storageKey);
      obj._fechaRegistro = new Date().toISOString();
      lista.push(obj);
      setData(storageKey, lista);
      if (idLista) pintarLista(storageKey, idLista, formatearLinea);
      form.reset();
      actualizarPanel();
      actualizarReportes();
      if (extraCallback) extraCallback(obj, lista);
      alert('Registro guardado.');
    });
    if (idLista) pintarLista(storageKey, idLista, formatearLinea);
  }

  function pintarLista(storageKey, idLista, formatearLinea) {
    const cont = document.getElementById(idLista);
    if (!cont) return;
    const lista = getData(storageKey);
    cont.innerHTML = '';
    if (!lista.length) {
      cont.innerHTML = '<div>Sin registros.</div>';
      return;
    }
    lista.slice().reverse().forEach(item => {
      const div = document.createElement('div');
      div.textContent = formatearLinea ? formatearLinea(item) : JSON.stringify(item);
      cont.appendChild(div);
    });
  }

  // ======================
  // Migración simple v39 -> v40 (no borra datos, solo copia si no hay nuevos)
  // ======================
  (function migracion(){
    const oldPesos = getData('pecuario_pesos'); // v38
    const newInd = getData('pecuario_pesaje_ind');
    if (oldPesos.length && !newInd.length) {
      const conv = oldPesos.map(p => ({
        areteOficial: p.areteOficial || '',
        areteRancho: '',
        sexo: '',
        fecha: p.fecha || '',
        peso: p.peso || '',
        ubicacion: p.lote || '',
        obs: p.obs || '',
        _fechaRegistro: p._fechaRegistro || new Date().toISOString()
      }));
      setData('pecuario_pesaje_ind', conv);
    }
  })();

  // ======================
  // Animales
  // ======================
  manejarFormulario(
    'form-animales',
    'pecuario_animales',
    'lista-animales',
    (a) => `Arete ${a.areteOficial || '-'} | Sexo: ${a.sexo || '-'} | Raza: ${a.razaPre || '-'} | Cruza: ${[a.cruza1,a.cruza2].filter(Boolean).join(' / ') || '-'} | Grupo: ${a.grupo || '-'}`,
    (obj, lista) => {
      if (typeof refrescarSelectorAnimalesCambioGrupo === 'function') refrescarSelectorAnimalesCambioGrupo();
    },
    (obj, form) => {
      if (!obj.grupo) {
        alert('Selecciona un grupo (obligatorio). Puedes usar "En espera" si aún no defines el grupo.');
        return false;
      }
      return true;
    }
  );


  // ======================
  // Pesajes: Individual
  // ======================
  function ultimoPesajeAnimal(arete) {
    const lista = getData('pecuario_pesaje_ind');
    const matches = lista.filter(x => (x.areteOficial||'') === (arete||'') && x.peso);
    if (matches.length < 2) return null;
    // último previo (antes del último)
    const last = matches[matches.length - 1];
    const prev = matches[matches.length - 2];
    const delta = (parseFloat(last.peso||0) - parseFloat(prev.peso||0));
    return { last, prev, delta };
  }

  manejarFormulario(
    'form-pesaje-ind',
    'pecuario_pesaje_ind',
    'lista-pesaje-ind',
    (p) => {
      const w = parseFloat(p.peso||0);
      const arete = p.areteOficial || '-';
      const deltaObj = ultimoPesajeAnimal(p.areteOficial);
      const deltaTxt = deltaObj ? ` | Δ vs último: ${deltaObj.delta.toFixed(1)} kg` : '';
      return `Arete ${arete} | Fecha: ${p.fecha || '-'} | Peso: ${w ? w.toFixed(1) : ''} kg | Ubicación: ${p.ubicacion || '-'}${deltaTxt}`;
    },
    (obj) => {
      const el = document.getElementById('notaDeltaInd');
      const info = ultimoPesajeAnimal(obj.areteOficial);
      if (el) {
        if (info) el.textContent = `Ganancia/Pérdida vs último pesaje: ${info.delta.toFixed(1)} kg (Arete ${obj.areteOficial}).`;
        else el.textContent = 'Primer pesaje de este arete (no hay comparación aún).';
      }
    }
  );

  // ======================
  // Pesajes: Grupo
  // ======================
  const formPesGrupo = document.getElementById('form-pesaje-grupo');
  if (formPesGrupo) {
    formPesGrupo.addEventListener('input', () => {
      const cabezas = parseFloat(formPesGrupo.cabezas.value || '0') || 0;
      const total = parseFloat(formPesGrupo.pesoTotal.value || '0') || 0;
      const prom = (cabezas > 0) ? (total / cabezas) : 0;
      formPesGrupo.pesoProm.value = prom ? prom.toFixed(1) : '';

      // delta promedio vs último del mismo "grupo"
      const g = formPesGrupo.grupo.value || '';
      const lista = getData('pecuario_pesaje_grupo').filter(x => (x.grupo||'') === g && x.pesoProm);
      if (lista.length) {
        const last = lista[lista.length - 1];
        const lastProm = parseFloat(last.pesoProm||0) || 0;
        const delta = prom - lastProm;
        formPesGrupo.deltaProm.value = (cabezas>0 && total>0 && g) ? delta.toFixed(1) : '';
      } else {
        formPesGrupo.deltaProm.value = '';
      }
    });
  }

  manejarFormulario(
    'form-pesaje-grupo',
    'pecuario_pesaje_grupo',
    'lista-pesaje-grupo',
    (p) => {
      const prom = parseFloat(p.pesoProm||0) || ((parseFloat(p.pesoTotal||0) || 0) / (parseFloat(p.cabezas||0) || 1));
      const delta = parseFloat(p.deltaProm||0);
      const deltaTxt = (p.deltaProm !== '' && !isNaN(delta)) ? ` | Δ prom: ${delta.toFixed(1)} kg/cab` : '';
      return `Grupo ${p.grupo || '-'} | Fecha: ${p.fecha || '-'} | Potrero: ${p.potrero || '-'} | Corral: ${p.corral || '-'} | Cabezas: ${p.cabezas || ''} | Total: ${p.pesoTotal || ''} kg | Prom: ${prom.toFixed(1)} kg/cab${deltaTxt}`;
    },
    (obj) => {
      const el = document.getElementById('notaDeltaGrupo');
      if (!el) return;
      if (obj.deltaProm) el.textContent = `Ganancia/Pérdida promedio vs último del grupo: ${obj.deltaProm} kg/cabeza.`;
      else el.textContent = 'Primer pesaje de este grupo (no hay comparación aún).';
    }
  );

  // ======================
  // Potreros: puntos GPS y área
  // ======================
  let puntos = [];
  const canvas = document.getElementById('canvasPotrero');
  const ctx = canvas ? canvas.getContext('2d') : null;
  const listaPuntosEl = document.getElementById('listaPuntos');
  const areaM2El = document.getElementById('areaM2');

  function limpiarPuntos() {
    puntos = [];
    renderPuntos();
  }
  window.limpiarPuntos = limpiarPuntos;

  function geoGetPoint() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error('Geolocalización no soportada'));
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          resolve({
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            acc: pos.coords.accuracy
          });
        },
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });
  }

  function areaPoligonoM2(latlon) {
    if (latlon.length < 3) return 0;
    // equirectangular projection around centroid
    const R = 6371000;
    const lat0 = latlon.reduce((s,p)=>s+p.lat,0)/latlon.length * Math.PI/180;
    const lon0 = latlon.reduce((s,p)=>s+p.lon,0)/latlon.length * Math.PI/180;

    const pts = latlon.map(p => {
      const lat = p.lat * Math.PI/180;
      const lon = p.lon * Math.PI/180;
      const x = (lon - lon0) * Math.cos(lat0) * R;
      const y = (lat - lat0) * R;
      return {x,y};
    });

    let sum = 0;
    for (let i=0;i<pts.length;i++) {
      const j = (i+1) % pts.length;
      sum += pts[i].x * pts[j].y - pts[j].x * pts[i].y;
    }
    return Math.abs(sum) / 2;
  }

  function drawPolygon(latlon) {
    if (!ctx || !canvas) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (latlon.length < 2) {
      ctx.fillStyle = '#7f8c8d';
      ctx.font = '14px system-ui';
      ctx.fillText('Agrega 3+ puntos GPS para dibujar el potrero.', 16, 28);
      return;
    }

    // normalize to canvas
    const lats = latlon.map(p=>p.lat);
    const lons = latlon.map(p=>p.lon);
    const minLat = Math.min(...lats), maxLat = Math.max(...lats);
    const minLon = Math.min(...lons), maxLon = Math.max(...lons);

    const pad = 26;
    const w = canvas.width - pad*2;
    const h = canvas.height - pad*2;

    function mapX(lon) {
      if (maxLon === minLon) return pad + w/2;
      return pad + (lon - minLon) / (maxLon - minLon) * w;
    }
    function mapY(lat) {
      if (maxLat === minLat) return pad + h/2;
      // invert y (north up)
      return pad + (maxLat - lat) / (maxLat - minLat) * h;
    }

    // path
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#8b4513';
    ctx.fillStyle = 'rgba(240,224,192,0.35)';

    ctx.beginPath();
    ctx.moveTo(mapX(latlon[0].lon), mapY(latlon[0].lat));
    for (let i=1;i<latlon.length;i++) {
      ctx.lineTo(mapX(latlon[i].lon), mapY(latlon[i].lat));
    }
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // points
    ctx.fillStyle = '#4b3b2d';
    latlon.forEach((p, idx) => {
      const x = mapX(p.lon), y = mapY(p.lat);
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI*2);
      ctx.fill();
      ctx.fillText(String(idx+1), x+8, y-8);
    });
  }

  function renderPuntos() {
    if (listaPuntosEl) {
      if (!puntos.length) {
        listaPuntosEl.textContent = 'Sin puntos aún.';
      } else {
        listaPuntosEl.innerHTML = puntos.map((p,i)=>`<div>#${i+1}: ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} (±${Math.round(p.acc||0)}m)</div>`).join('');
      }
    }
    drawPolygon(puntos);

    const area = areaPoligonoM2(puntos);
    if (areaM2El) areaM2El.value = area ? Math.round(area).toString() : '';
  }

  const btnPuntoGPS = document.getElementById('btnPuntoGPS');
  if (btnPuntoGPS) {
    btnPuntoGPS.addEventListener('click', async ()=> {
      try {
        const p = await geoGetPoint();
        puntos.push(p);
        renderPuntos();
      } catch(e) {
        alert('No se pudo tomar GPS. Revisa permisos de ubicación del navegador.');
      }
    });
  }
  const btnLimpiarGPS = document.getElementById('btnLimpiarGPS');
  if (btnLimpiarGPS) btnLimpiarGPS.addEventListener('click', ()=> limpiarPuntos());

  // Potreros storage
  manejarFormulario(
    'form-potreros',
    'pecuario_potreros',
    'lista-potreros',
    (p) => {
      const letra = p.letra || p.nombre || '-';
      const area = parseFloat(p.areaM2 || '0') || 0;
      const pts = (p.puntos && p.puntos.length) ? p.puntos.length : 0;
      const corrales = getData('pecuario_corrales').filter(c => (c.potrero||'') === letra && !(c.salida||'').trim());
      const cabezas = corrales.reduce((s,c)=> s + (parseFloat(c.cabezas||'0')||0), 0);
      const dens = (area>0 && cabezas>0) ? (cabezas * 10000 / area).toFixed(0) : '';
      const densTxt = dens ? ` | Densidad est.: ${dens} cab/ha` : '';
      return `Potrero ${letra} | Área: ${area ? area + ' m²' : '—'} | Puntos GPS: ${pts}${densTxt} | ${p.nombre ? 'Nombre: ' + p.nombre : ''}`;
    },
    (obj, lista) => {
      // anexar puntos y área al último registro guardado (obj)
      obj.puntos = puntos.slice();
      // Guardar área calculada desde los puntos (no desde el input, porque el form se resetea antes del callback)
      const areaCalc = (obj.puntos && obj.puntos.length >= 3) ? areaPoligonoM2(obj.puntos) : 0;
      obj.areaM2 = (obj.areaM2 && String(obj.areaM2).trim()) ? String(obj.areaM2).trim() : (areaCalc ? String(Math.round(areaCalc)) : '');
try { obj.img = (canvas && canvas.toDataURL) ? canvas.toDataURL('image/png') : ''; } catch(e){ obj.img=''; }
      // re-guardar corrigiendo el último elemento
      lista[lista.length - 1] = obj;
      setData('pecuario_potreros', lista);
      pintarLista('pecuario_potreros', 'lista-potreros', (p) => {
      const letra = p.letra || p.nombre || '-';
      const area = parseFloat(p.areaM2 || '0') || 0;
      const pts = (p.puntos && p.puntos.length) ? p.puntos.length : 0;
      const corrales = getData('pecuario_corrales').filter(c => (c.potrero||'') === letra && !(c.salida||'').trim());
      const cabezas = corrales.reduce((s,c)=> s + (parseFloat(c.cabezas||'0')||0), 0);
      const dens = (area>0 && cabezas>0) ? (cabezas * 10000 / area).toFixed(0) : '';
      const densTxt = dens ? ` | Densidad est.: ${dens} cab/ha` : '';
      return `Potrero ${letra} | Área: ${area ? area + ' m²' : '—'} | Puntos GPS: ${pts}${densTxt} | ${p.nombre ? 'Nombre: ' + p.nombre : ''}`;
    });
      limpiarPuntos();
    }
  );

  // ======================
  // Corrales
  // ======================
  manejarFormulario(
    'form-corrales',
    'pecuario_corrales',
    'lista-corrales',
    (c) => {
      const area = c.areaM2 || c.area || '';
      const cab = c.cabezas || '';
      const dens = c.cabezasHa || c.densidadAuto || c.densidad || '';
      return `Corral ${c.corralId || '-'} | Potrero ${c.potrero || '-'} | Área: ${area ? area + ' m²' : '-'} | Cabezas: ${cab || '-'} | Cab/ha: ${dens || '-'} | Grupo: ${c.grupo || '-'} | Entrada: ${c.entrada || '-'} | Salida: ${c.salida || ''}`;
    },
    (obj, lista) => {
      // anexar puntos/área/imagen del polígono del corral
      obj.puntos = (window.puntosCorral || []).slice();
      // Guardar área calculada desde los puntos (no desde el input, porque el form se resetea antes del callback)
      const areaCalc = (obj.puntos && obj.puntos.length >= 3) ? areaPoligonoM2(obj.puntos) : 0;
      obj.areaM2 = (obj.areaM2 && String(obj.areaM2).trim()) ? String(obj.areaM2).trim() : (areaCalc ? String(Math.round(areaCalc)) : (obj.areaM2 || obj.area || ''));
// cálculos
      const areaN = parseFloat(obj.areaM2 || '0') || 0;
      const cabN = parseFloat(obj.cabezas || '0') || 0;
      if (areaN > 0 && cabN > 0) {
        obj.m2PorCabeza = (areaN / cabN).toFixed(1);
        obj.cabezasHa = (cabN * 10000 / areaN).toFixed(0);
        obj.densidadAuto = obj.cabezasHa;
      } else {
        obj.m2PorCabeza = obj.m2PorCabeza || '';
        obj.cabezasHa = obj.cabezasHa || '';
        obj.densidadAuto = obj.densidadAuto || '';
      }
      try {
        const cv = document.getElementById('canvasCorral');
        obj.img = (cv && cv.toDataURL) ? cv.toDataURL('image/png') : '';
      } catch(e) { obj.img = obj.img || ''; }

      lista[lista.length - 1] = obj;
      setData('pecuario_corrales', lista);
      // re-pintar
      pintarLista('pecuario_corrales', 'lista-corrales', (c) => {
        const area = c.areaM2 || c.area || '';
        const cab = c.cabezas || '';
        const dens = c.cabezasHa || c.densidadAuto || c.densidad || '';
        return `Corral ${c.corralId || '-'} | Potrero ${c.potrero || '-'} | Área: ${area ? area + ' m²' : '-'} | Cabezas: ${cab || '-'} | Cab/ha: ${dens || '-'} | Grupo: ${c.grupo || '-'} | Entrada: ${c.entrada || '-'} | Salida: ${c.salida || ''}`;
      });

      if (typeof limpiarPuntosCorral === 'function') limpiarPuntosCorral();
    }
  );

  // ======================
  // Reproducción: calcular cruza cría y fecha probable
  // ======================
  function calcCruzaCria(form) {
    const partes = [];
    const add = (x)=>{ if (x && x.trim()) partes.push(x.trim()); };
    add(form.razaH.value); add(form.cruzaH1.value); add(form.cruzaH2.value);
    add('×');
    add(form.razaM.value); add(form.cruzaM1.value); add(form.cruzaM2.value);
    form.cruzaCria.value = partes.filter(Boolean).join(' ');
    if (form.cruzaPreH) form.cruzaPreH.value = form.razaH.value || '';
    if (form.cruzaPreM) form.cruzaPreM.value = form.razaM.value || '';
  }

  const formRepro = document.getElementById('form-repro');
  if (formRepro) {
    formRepro.addEventListener('change', ()=> calcCruzaCria(formRepro));
    formRepro.addEventListener('input', ()=> calcCruzaCria(formRepro));
  }
  const btnCalcularProb = document.getElementById('btnCalcularProb');
  if (btnCalcularProb && formRepro) {
    btnCalcularProb.addEventListener('click', ()=> {
      const fe = formRepro.fechaEmp.value;
      if (!fe) return alert('Primero captura la fecha de empadre.');
      const d = new Date(fe + 'T00:00:00');
      d.setDate(d.getDate() + 283);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      formRepro.fechaProb.value = `${yyyy}-${mm}-${dd}`;
    });
  }

  manejarFormulario(
    'form-repro',
    'pecuario_repro',
    'lista-repro',
    (r) => `Hembra ${r.vientre || '-'} (${r.razaH || '-'}) | Toro: ${r.toro || '-'} (${r.razaM || '-'}) | Empadre: ${r.fechaEmp || '-'} | Prob: ${r.fechaProb || '-'} | Parto: ${r.fechaParto || '-'} | Cría: ${r.sexoCria || '-'} ${r.pesoCria || ''} kg`,
    null
  );

  // ======================
  // Sanidad, Clima, Contabilidad, Seguridad, Maquinaria, Actividades
  // ======================
  manejarFormulario(
    'form-sanidad',
    'pecuario_sanidad',
    'lista-sanidad',
    (s) => `Arete ${s.arete || '-'} | ${s.tipo || ''} | Enf: ${s.enfermedad || '-'} | Tratamiento: ${s.tratamiento || '-'}`,
    null,
    (obj, form) => {
      // Enfermedad / motivo: mismo catálogo que en Nacimientos (con "Otro" editable)
      const cat = (obj.enfermedadCat || '').trim();
      const otro = (obj.enfermedadOtro || '').trim();

      if (cat === 'Otro') {
        if (!otro) {
          alert('Seleccionaste "Otro". Especifica la enfermedad/motivo.');
          return false;
        }
        obj.enfermedad = otro;
      } else if (cat) {
        obj.enfermedad = cat;
      } else {
        // Si no selecciona, se deja vacío (compatible con registros anteriores)
        obj.enfermedad = (obj.enfermedad || '').trim();
      }
      return true;
    }
  );
manejarFormulario(
    'form-conta',
    'pecuario_conta',
    'lista-conta',
    (c) => `${c.tipo || ''} | ${c.fecha || ''} | ${c.cuenta || '-'} | $${c.monto || ''}`,
    null
  );

  manejarFormulario(
    'form-visitas',
    'pecuario_visitas',
    null,
    null,
    null
  );
  manejarFormulario(
    'form-bitacora',
    'pecuario_bitacora',
    'lista-seguridad',
    (b) => `Fecha ${b.fecha || '-'} ${b.hora || ''} | Evento: ${b.evento || '-'}`,
    null
  );

  manejarFormulario(
    'form-maquinaria',
    'pecuario_maquinaria',
    'lista-maquinaria',
    (m) => `${m.tipo || '-'} | ${m.desc || '-'} | Cant: ${m.cantidad || ''} | Últ. mantto: ${m.fechaMant || '-'}`,
    null
  );

  
  // ======================
  // Actividades/Tareas (asignación por usuario)
  // ======================
  function getTareas(){ return getData('pecuario_actividades') || []; }
  function setTareas(t){ setData('pecuario_actividades', t || []); }

  function usuarioActualObj(){
    const nombre = localStorage.getItem('pecuario_usuario_actual') || '';
    return getUsuarios().find(x=>x.nombre===nombre) || null;
  }
  function rolBaseActual(){
    const u = usuarioActualObj();
    return u ? (u.rolBase || u.rol || '') : '';
  }
  function esAdministrador(){
    return ['Propietario','Gerente','Supervisor'].includes(rolBaseActual());
  }

  function ymd(d){
    const z = (n)=> String(n).padStart(2,'0');
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }

  function migrarActividadesATareas(){
    const arr = getData('pecuario_actividades') || [];
    if (!arr.length) return;
    // Si ya tiene 'estado', asumimos que ya son tareas
    if (arr.some(x=>x && typeof x==='object' && ('estado' in x))) return;

    const now = new Date();
    const tareas = [];
    arr.forEach((a,i)=>{
      if (!a || typeof a !== 'object') return;
      const desc = (a.actividad || a.actividadSeleccionada || '').trim();
      const asign = (a.responsable || '').trim();
      tareas.push({
        id: `t_${Date.now()}_${i}`,
        modulo: (a.modulo || '').trim(),
        descripcion: desc || 'Tarea',
        asignadoA: asign,
        periodicidad: (a.periodicidad || '').trim(),
        semaforo: (a.semaforo || '').trim(),
        notas: (a.notas || '').trim(),
        fechaInicio: (a.fechaInicio || '').trim(),
        fechaTermino: '',
        estado: 'Pendiente',
        creadoPor: (a.creadoPor || '').trim(),
        creadoEn: now.toISOString()
      });
    });
    setTareas(tareas);
  }

  function renderTareasUI(){
    const pend = document.getElementById('listaTareasPend');
    const comp = document.getElementById('listaTareasComp');
    const adminBox = document.getElementById('actAdminBox');
    if (!pend || !comp) return;

    const tareas = getTareas();
    const u = usuarioActualObj();
    const nombre = u ? u.nombre : '';

    // Mostrar/ocultar caja admin
    if (adminBox) adminBox.style.display = esAdministrador() ? '' : 'none';

    const visibles = esAdministrador()
      ? tareas
      : tareas.filter(t => String(t.asignadoA||'').trim() === String(nombre||'').trim());

    const pendientes = visibles.filter(t => (t.estado||'Pendiente') !== 'Completada');
    const completadas = visibles.filter(t => (t.estado||'') === 'Completada');

    const renderItem = (t)=> {
      const wrap = document.createElement('div');
      wrap.className = 'tarjeta';
      wrap.style.background = '#fff';
      wrap.style.border = '1px solid #e5e7eb';
      wrap.style.margin = '6px 0';
      wrap.style.padding = '10px';

      const inicio = (t.fechaInicio||'').trim();
      const fin = (t.fechaTermino||'').trim();
      const meta = [
        t.modulo ? `Módulo: ${t.modulo}` : '',
        inicio ? `Inicio: ${inicio}` : '',
        t.periodicidad ? `Periodicidad: ${t.periodicidad}` : '',
        (t.estado === 'Completada' && t.semaforo) ? `Semáforo: ${t.semaforo}` : '',
        (esAdministrador() && t.asignadoA) ? `Asignado a: ${t.asignadoA}` : ''
      ].filter(Boolean).join(' | ');

      if (!esAdministrador()){
        const lbl = document.createElement('label');
        lbl.style.display='flex';
        lbl.style.gap='10px';
        lbl.style.alignItems='flex-start';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = (t.estado === 'Completada');
        cb.disabled = (t.estado === 'Completada'); // una vez completada, no se desmarca
        cb.dataset.id = t.id;

        cb.addEventListener('change', ()=>{
          if (!cb.checked) return;
          const all = getTareas();
          const idx = all.findIndex(x=>x.id===t.id);
          if (idx>=0){
            all[idx].estado = 'Completada';
            if (!all[idx].fechaTermino) all[idx].fechaTermino = ymd(new Date());
            all[idx].terminadoPor = nombre;
            setTareas(all);
            renderTareasUI();
            actualizarReportes();
            actualizarPanel();
          }
        });

        const txt = document.createElement('div');
        txt.innerHTML =
          `<b>${escapeHtml(t.descripcion||'Tarea')}</b>` +
          (meta ? `<div class="nota" style="margin-top:4px;">${escapeHtml(meta)}</div>` : '') +
          (t.notas ? `<div class="nota" style="margin-top:4px;">Notas: ${escapeHtml(t.notas)}</div>` : '');

        lbl.appendChild(cb);
        lbl.appendChild(txt);
        wrap.appendChild(lbl);

        if (fin){
          const d = document.createElement('div');
          d.className='nota';
          d.style.marginTop='6px';
          d.textContent = `Terminada: ${fin}`;
          wrap.appendChild(d);
        }
        return wrap;
      }

      // Vista admin (Propietario/Gerente/Supervisor)
      const title = document.createElement('div');
      title.style.fontWeight='900';
      title.textContent = (t.descripcion||'Tarea');
      wrap.appendChild(title);

      if (meta){
        const mdiv = document.createElement('div');
        mdiv.className='nota';
        mdiv.style.marginTop='4px';
        mdiv.textContent = meta;
        wrap.appendChild(mdiv);
      }

      if (t.notas){
        const nd = document.createElement('div');
        nd.className='nota';
        nd.style.marginTop='4px';
        nd.textContent = `Notas: ${t.notas}`;
        wrap.appendChild(nd);
      }

      if (t.estado === 'Completada'){
        const d = document.createElement('div');
        d.className='nota';
        d.style.marginTop='6px';
        d.textContent = `Terminada: ${fin || '—'}` + (t.terminadoPor ? ` (por ${t.terminadoPor})` : '');
        wrap.appendChild(d);

        // Semáforo editable SOLO en tareas completadas
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.gap='8px';
        row.style.alignItems='center';
        row.style.flexWrap='wrap';
        row.style.marginTop='8px';

        const lab = document.createElement('span');
        lab.className='nota';
        lab.innerHTML = '<b>Semáforo:</b>';

        const sel = document.createElement('select');
        sel.style.padding='6px 8px';
        sel.style.borderRadius='10px';
        sel.style.border='1px solid #e5e7eb';
        sel.style.fontWeight='600';

        const opts = [
          {v:'', t:'Sin color'},
          {v:'Verde', t:'Verde'},
          {v:'Amarillo', t:'Amarillo'},
          {v:'Rojo', t:'Rojo'}
        ];
        opts.forEach(o=>{
          const op = document.createElement('option');
          op.value = o.v;
          op.textContent = o.t;
          sel.appendChild(op);
        });
        sel.value = (t.semaforo||'').trim();

        sel.addEventListener('change', ()=>{
          const all = getTareas();
          const idx = all.findIndex(x=>x.id===t.id);
          if (idx>=0){
            all[idx].semaforo = sel.value;
            setTareas(all);
            pintarToast('Semáforo actualizado');
            renderTareasUI();
            actualizarPanel();
            actualizarReportes();
          }
        });

        row.appendChild(lab);
        row.appendChild(sel);
        wrap.appendChild(row);
      } else {
        const p = document.createElement('div');
        p.className='nota';
        p.style.marginTop='6px';
        p.innerHTML = '<b>Pendiente</b>';
        wrap.appendChild(p);
      }

      return wrap;
    };

    const renderList = (arr, el, emptyText)=>{
      if (!arr.length){
        el.innerHTML = `<div class="nota">${emptyText}</div>`;
        return;
      }
      el.innerHTML = '';
      arr.slice().reverse().forEach(t=>{
        el.appendChild(renderItem(t));
      });
    };

    renderList(pendientes, pend, esAdministrador() ? 'Sin tareas pendientes.' : 'No tienes tareas pendientes.');
    renderList(completadas, comp, esAdministrador() ? 'Sin tareas completadas.' : 'No tienes tareas completadas.');
  }

  function poblarSelectUsuariosAsignacion(){
    const sel = document.getElementById('selAsignadoA');
    if (!sel) return;
    const usuarios = getUsuarios().filter(u=> (u.activo==='Activo' || u.activo==='Sí'));
    sel.innerHTML = '<option value="">Selecciona…</option>';
    usuarios.forEach(u=>{
      const o = document.createElement('option');
      o.value = u.nombre;
      o.textContent = u.nombre;
      sel.appendChild(o);
    });
  }

  function initTareasActividades(){
    migrarActividadesATareas();
    poblarSelectUsuariosAsignacion();

    // Default: fecha inicio hoy
    const form = document.getElementById('form-actividades');
    if (form){
      const fi = form.querySelector('input[name="fechaInicio"]');
      if (fi && !fi.value) fi.value = ymd(new Date());

      // Guardar tareas (solo admin)
      form.addEventListener('submit', (e)=>{
        if (!esAdministrador()) { e.preventDefault(); return; }
        e.preventDefault();

        const f = new FormData(form);
        const obj = {};
        f.forEach((v,k)=>obj[k]=String(v||''));
        const asignadoA = (obj.asignadoA||'').trim();
        if (!asignadoA){ alert('Selecciona a quién se asigna la tarea.'); return; }

        const inicio = (obj.fechaInicio||'').trim() || ymd(new Date());
        const modulo = (obj.modulo||'').trim();

        // Descripción (puede contener varias líneas = varias tareas)
        const descLibre = (obj.descripcionTarea||'').trim();
        const nuevos = descLibre.split(/\n+/).map(s=>s.trim()).filter(Boolean);

        if (!nuevos.length){
          alert('Escribe la descripción de la tarea.');
          return;
        }

        const tareas = getTareas();
        const creador = (usuarioActualObj() && usuarioActualObj().nombre) ? usuarioActualObj().nombre : '';

        nuevos.forEach((desc, i)=>{
          tareas.push({
            id: `t_${Date.now()}_${Math.random().toString(16).slice(2)}_${i}`,
            modulo,
            descripcion: desc,
            asignadoA,
            periodicidad: (obj.periodicidad||'').trim(),
            semaforo: '',
            notas: (obj.notas||'').trim(),
            fechaInicio: inicio,
            fechaTermino: '',
            estado: 'Pendiente',
            creadoPor: creador,
            creadoEn: new Date().toISOString()
          });
        });

        setTareas(tareas);
        pintarToast('Tarea(s) guardada(s)');
        form.reset();
        poblarSelectUsuariosAsignacion();
        const fi2 = form.querySelector('input[name="fechaInicio"]');
        if (fi2) fi2.value = ymd(new Date());
renderTareasUI();
        actualizarReportes();
        actualizarPanel();
      });
    }

    // Exponer para refresco al cambiar de usuario
    window.renderTareasUI = renderTareasUI;

    renderTareasUI();
  }

// Actividades/Tareas: manejo personalizado (asignación + checkboxes)
  initTareasActividades();

// Perfil del rancho
  (function () {
    const form = document.getElementById('form-config');
    if (!form) return;
    const saved = getData('pecuario_config');
    if (saved && saved.length) {
      const cfg = saved[saved.length - 1];
      Object.keys(cfg).forEach(k => {
        if (form.elements[k]) form.elements[k].value = cfg[k];
      });
    }
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const datos = new FormData(form);
      const obj = {};
      datos.forEach((val, key) => { obj[key] = val; });
      if (typeof validateCallback === 'function') { if (validateCallback(obj, form) === false) return; }

      const lista = getData('pecuario_config');
      lista.push(obj);
      setData('pecuario_config', lista);
      alert('Perfil guardado.');
      actualizarPanel();
      actualizarReportes();
    });
  })();

  // ======================
  // Razas: agregar
  // ======================
  const btnAgregarRaza = document.getElementById('btnAgregarRaza');
  if (btnAgregarRaza) {
    btnAgregarRaza.addEventListener('click', ()=> {
      const txt = document.getElementById('txtNuevaRaza');
      const raza = (txt.value || '').trim();
      if (!raza) return;
      const extra = getData('pecuario_razas_extra');
      extra.push(raza);
      setData('pecuario_razas_extra', extra);
      txt.value = '';
      refrescarRazasEnUI();
      alert('Raza agregada a las listas.');
    });
  }

  // ======================
  // Suplementos (modal)
  // ======================
  const modal = document.getElementById('modalSupl');
  const btnAbrirSuplementos = document.getElementById('btnAbrirSuplementos');
  const btnNuevoSupl = document.getElementById('btnNuevoSupl');
  const btnCerrarSupl = document.getElementById('btnCerrarSupl');
  const btnBorrarSupl = document.getElementById('btnBorrarSupl');

  function abrirModalSupl() {
    if (!modal) return;
    modal.classList.add('activo');
    const form = document.getElementById('form-supl');
    if (form) {
      form.reset();
      // inicializar ingredientes
      if (typeof initIngredientesUI === 'function') initIngredientesUI();
    }
  }
  function cerrarModalSupl() {
    if (!modal) return;
    modal.classList.remove('activo');
  }

  if (btnAbrirSuplementos) {
    btnAbrirSuplementos.addEventListener('click', ()=> {
      // si el usuario estaba capturando un corral, pre-llenar
      const f = document.getElementById('form-corrales');
      const c = f ? (f.corralId.value || '') : '';
      abrirModalSupl();
    });
  }
  if (btnNuevoSupl) btnNuevoSupl.addEventListener('click', ()=> abrirModalSupl());
  if (btnCerrarSupl) btnCerrarSupl.addEventListener('click', ()=> cerrarModalSupl());
  if (modal) {
    modal.addEventListener('click', (e)=> {
      if (e.target === modal) cerrarModalSupl();
    });
  }

  function pintarSuplementos() {
    const cont = document.getElementById('lista-supl');
    if (!cont) return;
    const lista = getData('pecuario_suplementos');
    cont.innerHTML = '';
    if (!lista.length) {
      cont.innerHTML = '<div>Sin registros.</div>';
      return;
    }
    lista.slice().reverse().forEach(s => {
      const div = document.createElement('div');
      const cor = s.corralId ? ` | Corral ${s.corralId}` : '';
      div.textContent = `${s.nombre || '-'}${cor} | Temporada/Clima: ${s.temporada || '-'} | Frec: ${s.frecuencia || '-'}`;
      cont.appendChild(div);
    });
  }

  const formSupl = document.getElementById('form-supl');
  if (formSupl) {
    formSupl.addEventListener('submit', (e)=> {
      e.preventDefault();
      if (typeof syncIngredientesJSON === 'function') syncIngredientesJSON();
      const datos = new FormData(formSupl);
      const obj = {};
      datos.forEach((val, key) => { obj[key] = val; });
      if (typeof validateCallback === 'function') { if (validateCallback(obj, form) === false) return; }

      const lista = getData('pecuario_suplementos');
      obj._fechaRegistro = new Date().toISOString();
      lista.push(obj);
      setData('pecuario_suplementos', lista);
      pintarSuplementos();
      actualizarPanel();
      actualizarReportes();
      cerrarModalSupl();
      alert('Suplemento guardado.');
    });
  }

  if (btnBorrarSupl) {
    btnBorrarSupl.addEventListener('click', ()=> {
      if (confirm('¿Borrar TODOS los suplementos?')) {
        setData('pecuario_suplementos', []);
        pintarSuplementos();
        actualizarReportes();
      }
    });
  }

  // ======================
  // Panel + Reportes
  // ======================
  function actualizarPanel() {
    const animales  = getData('pecuario_animales');
    const pesInd    = getData('pecuario_pesaje_ind');
    const pesGrp    = getData('pecuario_pesaje_grupo');
    const repro     = getData('pecuario_repro');
    const sanidad   = getData('pecuario_sanidad');
    const visitas   = getData('pecuario_visitas');
    const bitacora  = getData('pecuario_bitacora');
const conta     = getData('pecuario_conta');
    const corrales  = getData('pecuario_corrales');

    document.getElementById('pnl-animales').textContent = animales.length;
    document.getElementById('pnl-pesajes').textContent  = pesInd.length + pesGrp.length;

    const nac = repro.filter(r => (r.fechaParto || '').trim() !== '').length;
    document.getElementById('pnl-nacimientos').textContent = nac;

    document.getElementById('pnl-sanidad').textContent  = sanidad.length;
    document.getElementById('pnl-seguridad').textContent = visitas.length + bitacora.length;
// Corrales abiertos por potrero (parcela)
    const abiertos = (corrales||[]).filter(c => !(c.salida||'').trim());
    const byPot = {};
    abiertos.forEach(c => {
      const p = (c.potrero||'—').trim() || '—';
      byPot[p] = (byPot[p]||0) + 1;
    });
    const txt = Object.keys(byPot).sort().map(k => `${k}: ${byPot[k]}`).join(' | ');
    const elCorr = document.getElementById('pnl-corrales-abiertos');
    if (elCorr) elCorr.textContent = txt || '0';

    let totalIng = 0;
    let totalGas = 0;
    conta.forEach(c => {
      const monto = parseFloat(c.monto || '0') || 0;
      if (c.tipo === 'Ingreso') totalIng += monto;
      if (c.tipo === 'Gasto')   totalGas += monto;
    });
    document.getElementById('pnl-conta').textContent =
      `$${totalIng.toFixed(2)} / $${totalGas.toFixed(2)}`;
  }

  function actualizarReportes() {
    const setCount = (id, n) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(n);
    };

    setCount('rep-animales',    getData('pecuario_animales').length);
    setCount('rep-pesajes',     getData('pecuario_pesaje_ind').length + getData('pecuario_pesaje_grupo').length);
    setCount('rep-repro',       getData('pecuario_repro').length);
    setCount('rep-sanidad',     getData('pecuario_sanidad').length);
setCount('rep-conta',       getData('pecuario_conta').length);
    setCount('rep-seguridad',   getData('pecuario_visitas').length + getData('pecuario_bitacora').length);
    setCount('rep-maquinaria',  getData('pecuario_maquinaria').length);
    setCount('rep-actividades', getTareas().length);
    setCount('rep-potreros',    getData('pecuario_potreros').length);
    setCount('rep-corrales',    getData('pecuario_corrales').length);
    setCount('rep-supl',        getData('pecuario_suplementos').length + getData('pecuario_supl_suministros').length);
  }


  // ======================
  // v40 — mejoras solicitadas

  function pintarToast(msg){
    const id='toastPecuarioGB';
    let el=document.getElementById(id);
    if(!el){
      el=document.createElement('div');
      el.id=id;
      el.style.position='fixed';
      el.style.left='50%';
      el.style.bottom='18px';
      el.style.transform='translateX(-50%)';
      el.style.background='rgba(17,24,39,0.92)';
      el.style.color='#fff';
      el.style.padding='10px 14px';
      el.style.borderRadius='12px';
      el.style.fontWeight='700';
      el.style.zIndex='9999';
      el.style.opacity='0';
      el.style.transition='opacity .2s ease';
      document.body.appendChild(el);
    }
    el.textContent=msg||'Listo';
    el.style.opacity='1';
    clearTimeout(el._t);
    el._t=setTimeout(()=>{ el.style.opacity='0'; }, 1800);
  }


  // ======================


  function refrescarCorralesEnUI(){
    // Para selects dependientes (ej. suplementos)
    const selPot = document.getElementById('selPotreroSupl');
    const selCor = document.getElementById('selCorralSupl');
    if (!selPot || !selCor) return;
    const p = selPot.value || '';
    const corr = getData('pecuario_corrales').filter(c => (c.potrero||'')===p && !(c.salida||'').trim());
    selCor.innerHTML = '<option value="">Selecciona…</option>';
    corr.forEach(c=>{
      const id = (c.corralId||'').trim();
      if (!id) return;
      const o = document.createElement('option');
      o.value = id;
      o.textContent = `Corral ${id}`;
      selCor.appendChild(o);
    });
  }

  // --------- Pesaje: ubicaciones (Potrero/Corral) + sexo automático ----------
  function refrescarUbicacionesEnUI(){
    const sel = document.getElementById('selUbicInd');
    if (!sel) return;
    const potreros = getData('pecuario_potreros').map(p => (p.letra||'').trim()).filter(Boolean);
    const corrales = getData('pecuario_corrales');
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Selecciona…';
    sel.appendChild(opt0);

    // Potreros
    potreros.forEach(l => {
      const o = document.createElement('option');
      o.value = `Potrero ${l}`;
      o.textContent = `Potrero ${l}`;
      sel.appendChild(o);
    });

    // Corrales
    corrales.forEach(c => {
      const p = (c.potrero||'').trim();
      const id = (c.corralId||'').trim();
      if (!p || !id) return;
      const o = document.createElement('option');
      o.value = `Potrero ${p} / Corral ${id}`;
      o.textContent = `Potrero ${p} / Corral ${id}`;
      sel.appendChild(o);
    });
  }

  function buscarAnimalPorArete(areteOficial){
    const a = (areteOficial||'').trim();
    if (!a) return null;
    const animales = getData('pecuario_animales');
    return animales.find(x => (x.areteOficial||'').trim() === a) || null;
  }

  (function initPesajeAuto(){
    const form = document.getElementById('form-pesaje-ind');
    if (!form) return;
    const inArete = form.querySelector('input[name="areteOficial"]');
    const inAreteR = form.querySelector('input[name="areteRancho"]');
    const selSexo = document.getElementById('selSexoPesInd');

    const sync = ()=>{
      const a = buscarAnimalPorArete(inArete ? inArete.value : '');
      if (!a) return;
      if (inAreteR && !inAreteR.value) inAreteR.value = a.areteRancho || '';
      if (selSexo && a.sexo) selSexo.value = a.sexo;
    };

    if (inArete) {
      inArete.addEventListener('change', sync);
      inArete.addEventListener('blur', sync);
    }
  })();

  // --------- GPS Corrales ----------
  window.puntosCorral = [];
  function drawPolygonOn(canvas, points){
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (!points || points.length < 2) return;

    // bbox
    let minLat=Infinity,maxLat=-Infinity,minLon=Infinity,maxLon=-Infinity;
    points.forEach(p=>{
      minLat=Math.min(minLat,p.lat); maxLat=Math.max(maxLat,p.lat);
      minLon=Math.min(minLon,p.lon); maxLon=Math.max(maxLon,p.lon);
    });
    const pad=20;
    const w=canvas.width-2*pad, h=canvas.height-2*pad;
    const dx = (maxLon-minLon) || 1e-9;
    const dy = (maxLat-minLat) || 1e-9;

    const xy = (p)=>{
      const x = pad + ((p.lon - minLon)/dx)*w;
      const y = pad + (1-((p.lat - minLat)/dy))*h;
      return {x,y};
    };

    // poly
    ctx.beginPath();
    points.forEach((p,i)=>{
      const {x,y}=xy(p);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.closePath();
    ctx.lineWidth=3;
    ctx.strokeStyle='rgba(209,0,0,0.85)';
    ctx.stroke();
    ctx.fillStyle='rgba(209,0,0,0.08)';
    ctx.fill();

    // vertices
    points.forEach((p,i)=>{
      const {x,y}=xy(p);
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fillStyle='rgba(17,24,39,0.85)';
      ctx.fill();
      ctx.font='12px system-ui';
      ctx.fillText(String(i+1), x+6, y-6);
    });
  }

  function renderPuntosCorral(){
    const lista = document.getElementById('listaPuntosCorral');
    const areaEl = document.getElementById('areaCorralM2');
    const canvas = document.getElementById('canvasCorral');
    if (lista) {
      if (!window.puntosCorral.length) lista.textContent = 'Sin puntos aún.';
      else lista.textContent = window.puntosCorral.map((p,i)=>`${i+1}. ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}`).join(' | ');
    }
    if (areaEl) {
      const area = window.puntosCorral.length >=3 ? areaPoligonoM2(window.puntosCorral) : 0;
      areaEl.value = area ? String(Math.round(area)) : '';
    }
    if (canvas) drawPolygonOn(canvas, window.puntosCorral);

    recalcularCorralForm();
  }

  function limpiarPuntosCorral(){
    window.puntosCorral = [];
    renderPuntosCorral();
  }

  function recalcularCorralForm(){
    const form = document.getElementById('form-corrales');
    if (!form) return;
    const area = parseFloat((form.areaM2 && form.areaM2.value) ? form.areaM2.value : '0') || 0;
    const cab  = parseFloat(form.cabezas ? form.cabezas.value : '0') || 0;

    const m2El = form.m2PorCabeza;
    const haEl = form.cabezasHa;
    const densEl = form.densidadAuto;

    if (area>0 && cab>0) {
      const m2 = area/cab;
      const ha = cab*10000/area;
      if (m2El) m2El.value = m2.toFixed(1);
      if (haEl) haEl.value = ha.toFixed(0);
      if (densEl) densEl.value = ha.toFixed(0);
    } else {
      if (m2El) m2El.value = '';
      if (haEl) haEl.value = '';
      if (densEl) densEl.value = '';
    }
  }

  (function initGPSCorral(){
    const b1 = document.getElementById('btnPuntoGPSCorral');
    const b2 = document.getElementById('btnLimpiarGPSCorral');
    if (b1) b1.addEventListener('click', async ()=>{
      const p = await geoGetPoint();
      if (!p) return;
      window.puntosCorral.push(p);
      renderPuntosCorral();
    });
    if (b2) b2.addEventListener('click', limpiarPuntosCorral);

    const form = document.getElementById('form-corrales');
    if (form && form.cabezas) {
      form.cabezas.addEventListener('input', recalcularCorralForm);
    }
    renderPuntosCorral();
  })();

  // --------- Mapa de corrales dentro del potrero ----------
  (function initMapaCorrales(){
    const btn = document.getElementById('btnMapaCorrales');
    const info = document.getElementById('mapaCorralesInfo');
    const canvas = document.getElementById('canvasPotrero');
    const form = document.getElementById('form-potreros');
    if (!btn || !canvas || !form) return;

    btn.addEventListener('click', ()=>{
      const letra = (form.letra && form.letra.value) ? form.letra.value : '';
      if (!letra) { if (info) info.textContent = 'Selecciona primero el potrero.'; return; }
      const potPts = (window.puntos||[]).slice();
      if (potPts.length < 3) { if (info) info.textContent = 'Captura el polígono del potrero (GPS) para poder generar el mapa.'; return; }
      const corr = getData('pecuario_corrales').filter(c => (c.potrero||'')===letra && c.puntos && c.puntos.length>=3);

      // dibujar potrero base
      drawPolygonOn(canvas, potPts);

      // dibujar corrales encima, mismo bbox conjunto (recalcular bbox global)
      const allPts = potPts.concat(...corr.map(c=>c.puntos));
      let minLat=Infinity,maxLat=-Infinity,minLon=Infinity,maxLon=-Infinity;
      allPts.forEach(p=>{
        minLat=Math.min(minLat,p.lat); maxLat=Math.max(maxLat,p.lat);
        minLon=Math.min(minLon,p.lon); maxLon=Math.max(maxLon,p.lon);
      });
      const ctx = canvas.getContext('2d');
      const pad=20;
      const w=canvas.width-2*pad, h=canvas.height-2*pad;
      const dx=(maxLon-minLon)||1e-9, dy=(maxLat-minLat)||1e-9;
      const xy=(p)=>({x: pad + ((p.lon-minLon)/dx)*w, y: pad + (1-((p.lat-minLat)/dy))*h});

      corr.forEach((c,idx)=>{
        const pts=c.puntos;
        ctx.beginPath();
        pts.forEach((p,i)=>{
          const {x,y}=xy(p);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.lineWidth=2;
        ctx.strokeStyle='rgba(17,24,39,0.8)';
        ctx.stroke();
        ctx.fillStyle='rgba(17,24,39,0.05)';
        ctx.fill();

        // etiqueta
        const c0=xy(pts[0]);
        ctx.font='12px system-ui';
        ctx.fillStyle='rgba(17,24,39,0.85)';
        ctx.fillText(`C${c.corralId||idx+1}`, c0.x+6, c0.y+12);
      });

      // guardar imagen dentro del registro del potrero (último por letra)
      try{
        const img = canvas.toDataURL('image/png');
        const potreros = getData('pecuario_potreros');
        for (let i=potreros.length-1; i>=0; i--){
          if ((potreros[i].letra||'')===letra){
            potreros[i].mapaCorralesImg = img;
            setData('pecuario_potreros', potreros);
            break;
          }
        }
      }catch(e){}

      const cabezas = corr.reduce((s,c)=> s + (parseFloat(c.cabezas||'0')||0), 0);
      if (info) info.textContent = `Mapa generado. Corrales con polígono: ${corr.length}. Cabezas (suma): ${cabezas}.`;
    });
  })();

  // --------- Suplementos: ingredientes en tabla + suministro por corral ----------
  function initIngredientesUI(){
    const wrap = document.getElementById('ingWrap');
    if (!wrap) return;
    wrap.innerHTML = '';
    addIngredienteRow(); addIngredienteRow();
  }

  function addIngredienteRow(nombre='', pct=''){
    const wrap = document.getElementById('ingWrap');
    if (!wrap) return;
    const row = document.createElement('div');
    row.className = 'fila-tres';
    row.style.gridTemplateColumns = '2fr 1fr auto';

    const a = document.createElement('div');
    a.innerHTML = `<label>Ingrediente</label><input class="ing-nombre" value="${(nombre||'').replace(/"/g,'&quot;')}" placeholder="Ej. Maíz" />`;
    const b = document.createElement('div');
    b.innerHTML = `<label>%</label><input type="number" step="0.1" class="ing-pct" value="${pct}" placeholder="0" />`;
    const c = document.createElement('div');
    c.innerHTML = `<label>&nbsp;</label><button type="button" class="btn-secundario">Quitar</button>`;
    c.querySelector('button').addEventListener('click', ()=>row.remove());

    row.appendChild(a); row.appendChild(b); row.appendChild(c);
    wrap.appendChild(row);
  }

  function syncIngredientesJSON(){
    const wrap = document.getElementById('ingWrap');
    const hid  = document.getElementById('ingredientesJSON');
    if (!wrap || !hid) return;
    const rows = [...wrap.querySelectorAll('.fila-tres')];
    const out = rows.map(r=>{
      const n = r.querySelector('.ing-nombre')?.value?.trim() || '';
      const p = parseFloat(r.querySelector('.ing-pct')?.value || '0') || 0;
      return n ? {ingrediente:n, porcentaje:p} : null;
    }).filter(Boolean);
    hid.value = JSON.stringify(out);
  }

  (function initSuplUI(){
    const btnAdd = document.getElementById('btnAddIng');
    const btnClr = document.getElementById('btnClearIng');
    if (btnAdd) btnAdd.addEventListener('click', ()=>addIngredienteRow());
    if (btnClr) btnClr.addEventListener('click', initIngredientesUI);

    // Catálogo -> select
    function refrescarCatalogo(){
      const sel = document.getElementById('selSuplCatalogo');
      if (!sel) return;
      const cat = getData('pecuario_suplementos');
      sel.innerHTML = '<option value="">Selecciona…</option>';
      cat.forEach(s=>{
        const clave = (s.clave||s.nombre||'').trim();
        if (!clave) return;
        const o = document.createElement('option');
        o.value = clave;
        o.textContent = `${clave} — ${s.nombre||''}`;
        sel.appendChild(o);
      });
    }

    function refrescarCorralesSupl(){
      const selPot = document.getElementById('selPotreroSupl');
      const selCor = document.getElementById('selCorralSupl');
      if (!selPot || !selCor) return;
      const p = selPot.value || '';
      const corr = getData('pecuario_corrales').filter(c => (c.potrero||'')===p && !(c.salida||'').trim());
      selCor.innerHTML = '<option value="">Selecciona…</option>';
      corr.forEach(c=>{
        const id = (c.corralId||'').trim();
        if (!id) return;
        const o = document.createElement('option');
        o.value = id;
        o.textContent = `Corral ${id}`;
        selCor.appendChild(o);
      });
    }

    function refrescarCabezas(){
      const selPot = document.getElementById('selPotreroSupl');
      const selCor = document.getElementById('selCorralSupl');
      const out = document.getElementById('suplCabezas');
      if (!selPot || !selCor || !out) return;
      const p = selPot.value || '';
      const cId = selCor.value || '';
      if (!p || !cId) { out.value=''; return; }
      const corr = getData('pecuario_corrales').slice().reverse().find(c => (c.potrero||'')===p && (c.corralId||'')===cId && !(c.salida||'').trim());
      out.value = corr ? (corr.cabezas || '') : '';
    }

    function renderSuministros(){
      const cont = document.getElementById('lista-supl-suministros');
      if (!cont) return;
      const regs = getData('pecuario_supl_suministros');
      if (!regs.length) { cont.innerHTML = '<div>Sin registros.</div>'; return; }
      const byP = {};
      regs.slice().reverse().forEach(r=>{
        const p = r.potrero || '—';
        byP[p] = byP[p] || [];
        byP[p].push(r);
      });
      cont.innerHTML = '';
      Object.keys(byP).sort().forEach(p=>{
        const h = document.createElement('div');
        h.innerHTML = `<b>Potrero ${p}</b>`;
        cont.appendChild(h);
        byP[p].forEach(r=>{
          const d = document.createElement('div');
          d.textContent = `${r.fecha||'-'} | Corral ${r.corralId||'-'} | Cabezas: ${r.cabezas||'-'} | ${r.suplClave||'-'} | ${r.cantidad||''}${r.unidad||''}/cab | ${r.frecuencia||''} | ${r.uso||''}`;
          cont.appendChild(d);
        });
        const sep = document.createElement('hr');
        sep.style.border='none'; sep.style.borderTop='1px solid #e5e7eb'; sep.style.margin='10px 0';
        cont.appendChild(sep);
      });
    }

    // listeners
    const selPot = document.getElementById('selPotreroSupl');
    const selCor = document.getElementById('selCorralSupl');
    if (selPot) selPot.addEventListener('change', ()=>{ refrescarCorralesSupl(); refrescarCabezas(); });
    if (selCor) selCor.addEventListener('change', refrescarCabezas);

    // suministro submit
    const form = document.getElementById('form-supl-suministro');
    if (form) {
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const datos = new FormData(form);
        const obj = {};
        datos.forEach((v,k)=>obj[k]=String(v||''));
// completar cabezas auto si falta
        if (!obj.cabezas) obj.cabezas = (document.getElementById('suplCabezas')?.value)||'';
        const lista = getData('pecuario_supl_suministros');
        lista.push(obj);
        setData('pecuario_supl_suministros', lista);
        pintarToast('Suministro guardado');
        form.reset();
        refrescarCorralesSupl();
        refrescarCabezas();
        renderSuministros();
        actualizarReportes();
      });
    }

    // sobre-escribir pintarSuplementos para catálogo
    window.pintarSuplementos = function(){
      const cont = document.getElementById('lista-supl');
      if (!cont) return;
      const lista = getData('pecuario_suplementos');
      cont.innerHTML = '';
      if (!lista.length) { cont.innerHTML = '<div>Sin suplementos.</div>'; refrescarCatalogo(); return; }
      lista.slice().reverse().forEach(s=>{
        const d = document.createElement('div');
        const clave = s.clave || s.nombre || '';
        const uso = s.uso ? ` | Uso: ${s.uso}` : '';
        d.textContent = `${clave} | ${s.nombre||''}${uso} | Temporada: ${s.temporada||''}`;
        cont.appendChild(d);
      });
      refrescarCatalogo();
    };

    // inicial
    refrescarCatalogo();
    refrescarCorralesSupl();
    refrescarCabezas();
    renderSuministros();
  })();

  // --------- Nacimientos: salud "Otro" ----------
  (function initNacimientos(){
    const sel = document.getElementById('selSaludNac');
    const wrap = document.getElementById('wrapSaludOtro');
    if (!sel || !wrap) return;
    const on = ()=>{ wrap.style.display = (sel.value==='Otro') ? 'block' : 'none'; };
    sel.addEventListener('change', on);
    on();
  })();

  // --------- Sanidad: Enfermedad "Otro" ----------
  (function initSanidadEnfermedad(){
    const sel = document.getElementById('selEnfSan');
    const wrap = document.getElementById('wrapEnfSanOtro');
    const form = document.getElementById('form-sanidad');
    if (!sel || !wrap) return;
    const on = ()=>{ wrap.style.display = (sel.value==='Otro') ? 'block' : 'none'; };
    sel.addEventListener('change', on);
    if (form) form.addEventListener('reset', ()=>setTimeout(on,0));
    on();
  })();


  
;

  
  // --------- Pronóstico 7 días (Panel) - Open-Meteo ----------
  (function initPronosticoPanel(){
    const btnPerm = document.getElementById('btnPermitirUbicacion');
    const btnUpd  = document.getElementById('btnActualizarPronostico');
    const grid    = document.getElementById('wx7');
    const status  = document.getElementById('wxStatus');
    const accumEl = document.getElementById('wxAccum');
    if (!btnPerm || !btnUpd || !grid) return;

    const W = {
      0:'Despejado', 1:'Mayormente despejado', 2:'Parcialmente nublado', 3:'Nublado',
      45:'Niebla', 48:'Niebla escarchada',
      51:'Llovizna ligera', 53:'Llovizna', 55:'Llovizna intensa',
      61:'Lluvia ligera', 63:'Lluvia', 65:'Lluvia intensa',
      71:'Nieve ligera', 73:'Nieve', 75:'Nieve intensa',
      80:'Chubascos ligeros', 81:'Chubascos', 82:'Chubascos intensos',
      95:'Tormenta', 96:'Tormenta con granizo', 99:'Tormenta con granizo'
    };
    const D = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];

    const iconSvg = (kind) => {
      if (kind === 'sun') return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="4.5" stroke="#8b4513" stroke-width="2"/>
          <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M19.8 4.2l-2.1 2.1M6.3 17.7l-2.1 2.1"
            stroke="#8b4513" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
      if (kind === 'rain') return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7.5 18.5h9.2a4.3 4.3 0 0 0 0-8.6h-.4A5.6 5.6 0 0 0 6 10.6a3.9 3.9 0 0 0 1.5 7.9z"
            stroke="#4b3b2d" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 20.5l-1 2M13 20.5l-1 2M17 20.5l-1 2" stroke="#1f2937" stroke-width="2" stroke-linecap="round"/>
        </svg>`;
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7.5 18.5h9.2a4.3 4.3 0 0 0 0-8.6h-.4A5.6 5.6 0 0 0 6 10.6a3.9 3.9 0 0 0 1.5 7.9z"
            stroke="#4b3b2d" stroke-width="2" stroke-linejoin="round"/>
        </svg>`;
    };

    const kindFromCode = (code) => {
      code = Number(code);
      if (code === 0 || code === 1) return 'sun';
      if (code === 2 || code === 3 || code === 45 || code === 48) return 'cloud';
      if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82) || (code >= 95 && code <= 99)) return 'rain';
      return 'cloud';
    };

    const fmtYMD = (d)=>{
      const z=(n)=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    };

    let lastPos = null;

    async function ensurePos(){
      try{
        if (status) status.textContent = 'Solicitando ubicación…';
        const p = await geoGetPoint();
        lastPos = p;
        if (status) status.textContent = `Ubicación OK (±${Math.round(p.acc||0)}m).`;
        return p;
      } catch (e) {
        if (status) status.textContent = 'Ubicación no disponible. Revisa permisos del navegador.';
        throw e;
      }
    }

    async function cargarAcumuladoAnual(p){
      if (!accumEl) return;
      try{
        const today = new Date();
        const year = today.getFullYear();
        const start = `${year}-01-01`;
        const end = fmtYMD(today);
        accumEl.textContent = 'Calculando acumulado anual…';
        const urlA = `https://archive-api.open-meteo.com/v1/archive?latitude=${p.lat}&longitude=${p.lon}&start_date=${start}&end_date=${end}&daily=precipitation_sum&timezone=auto`;
        const rA = await fetch(urlA);
        if (!rA.ok) throw new Error('Error acumulado');
        const dA = await rA.json();
        const ps = (dA.daily && dA.daily.precipitation_sum) ? dA.daily.precipitation_sum : [];
        const sum = (ps||[]).reduce((a,b)=>a + (Number(b)||0), 0);
        accumEl.textContent = `Acumulado lluvia ${year} (1 Ene – ${end}): ${sum.toFixed(1)} mm`;
      } catch(e){
        accumEl.textContent = 'Acumulado anual: —';
      }
    }

    async function cargar(){
      try{
        const p = lastPos || await ensurePos();
        grid.innerHTML = '<div class="nota">Cargando pronóstico…</div>';

        const url = `https://api.open-meteo.com/v1/forecast?latitude=${p.lat}&longitude=${p.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
        const r = await fetch(url);
        if (!r.ok) throw new Error('Error al consultar clima');
        const data = await r.json();

        const daily = data.daily || {};
        const fechas = (daily.time || []).slice(0, 7);
        const tmax = (daily.temperature_2m_max || []).slice(0, 7);
        const tmin = (daily.temperature_2m_min || []).slice(0, 7);
        const code = (daily.weathercode || []).slice(0, 7);
        const rain = (daily.precipitation_sum || []).slice(0, 7);

        if (!fechas.length) {
          grid.innerHTML = '<div class="nota">Sin datos de pronóstico.</div>';
          return;
        }

        grid.innerHTML = '';
        fechas.forEach((iso, i)=>{
          const d = new Date(String(iso) + 'T12:00:00');
          const day = D[d.getDay()] || String(iso);
          const kind = kindFromCode(code[i]);
          const desc = W[code[i]] || '';
          const mm = Number(rain[i] ?? 0);

          const card = document.createElement('div');
          card.className = 'wx-card';
          card.innerHTML = `
            <div class="wx-day">${day}</div>
            <div class="wx-icon" title="${desc}">${iconSvg(kind)}</div>
            <div class="wx-temp">${Math.round(tmax[i])}° <small>/ ${Math.round(tmin[i])}°</small></div>
            <div class="wx-rain">${mm.toFixed(1)} mm</div>
          `;
          grid.appendChild(card);
        });

        await cargarAcumuladoAnual(p);

        if (status) status.textContent = `Actualizado: ${new Date().toLocaleString()}`;
      } catch (e) {
        grid.innerHTML = '<div class="nota">No se pudo cargar el pronóstico. Revisa internet y permisos de ubicación.</div>';
        if (accumEl) accumEl.textContent = 'Acumulado anual: —';
      }
    }

    btnPerm.addEventListener('click', async ()=>{ try { await ensurePos(); await cargar(); } catch(e){} });
    btnUpd.addEventListener('click', cargar);
  })();
// --------- Usuarios y permisos ----------
  const MODS = [
    {id:'panel', label:'Panel'},
    {id:'animales', label:'Animales'},
    {id:'potreros', label:'Potreros y Corrales'},
    {id:'repro', label:'Reproducción y partos'},
    {id:'sanidad', label:'Sanidad'},    {id:'conta', label:'Contabilidad'},
    {id:'seguridad', label:'Registros del Velador'},
    {id:'maquinaria', label:'Maquinaria y equipo'},
    {id:'actividades', label:'Actividades'},
    {id:'reportes', label:'Reportes'},
    {id:'config', label:'Perfil del rancho'}
  ];

  function normalizeUsuarios(arr){
    const baseRoles = new Set(["Propietario","Gerente","Supervisor","Vaquero","Auxiliar","Otro"]);
    return (arr||[]).map((u)=>{
      const uu = Object.assign({}, u||{});
      let r = String(uu.rol||'').trim();
      // Migración: "Consulta" se trata como "Otro"
      if (r === 'Consulta') r = 'Otro';

      if (!uu.rolBase){
        uu.rolBase = baseRoles.has(r) ? r : 'Otro';
      }

      // Si rolBase no es "Otro", el rol visible = rolBase
      if (uu.rolBase !== 'Otro'){
        uu.rol = uu.rolBase;
      } else {
        // "Otro": conserva nombre personalizado si existe; si no, usa "Otro"
        const custom = String(uu.rol||'').trim();
        uu.rol = (custom && custom !== 'Consulta') ? custom : 'Otro';
      }

      return uu;
    });
  }

  function getUsuarios(){ return normalizeUsuarios(getData('pecuario_usuarios') || []); }
  function setUsuarios(u){ setData('pecuario_usuarios', normalizeUsuarios(u)); }

  function renderPermisosCheckboxes(){
    const cont = document.getElementById('chkPermisos');
    if (!cont) return;
    cont.innerHTML = '';
    MODS.forEach(m=>{
      const row = document.createElement('div');
      row.style.display='inline-flex';
      row.style.alignItems='center';
      row.style.gap='8px';
      row.style.margin='6px 12px 6px 0';
      row.innerHTML = `<input type="checkbox" id="perm_${m.id}" value="${m.id}" checked> <label for="perm_${m.id}">${m.label}</label>`;
      cont.appendChild(row);
    });
  }

  function renderListaUsuarios(){
    const cont = document.getElementById('lista-usuarios');
    if (!cont) return;
    const usuarios = getUsuarios();
    if (!usuarios.length) { cont.innerHTML = '<div>Sin usuarios.</div>'; return; }
    cont.innerHTML = '';
    usuarios.slice().reverse().forEach(u=>{
      const d = document.createElement('div');
      const perms = (u.permisos||[]).join(', ');
      d.textContent = `${u.nombre} | ${u.rol} | Estado: ${u.activo} | Permisos: ${perms}`;
      cont.appendChild(d);
    });
  }

  function asegurarUsuarioDefault(){
    const u = getUsuarios();
    if (u.length) return;
    const all = MODS.map(m=>m.id);
    setUsuarios([{nombre:'Gilberto', rol:'Propietario', activo:'Activo', permisos: all}]);
    localStorage.setItem('pecuario_usuario_actual', 'Gilberto');
  }

  function llenarUsuariosHeader(){
    const sel = document.getElementById('selUsuario');
    const lbl = document.getElementById('lblRol');
    if (!sel || !lbl) return;
    const usuarios = getUsuarios().filter(u=> (u.activo==='Activo' || u.activo==='Sí'));
    sel.innerHTML = '';
    usuarios.forEach(u=>{
      const o=document.createElement('option');
      o.value=u.nombre;
      o.textContent=u.nombre;
      sel.appendChild(o);
    });
    const actual = localStorage.getItem('pecuario_usuario_actual') || (usuarios[0]?.nombre||'');
    if (actual) sel.value = actual;
    const uAct = usuarios.find(x=>x.nombre===sel.value) || usuarios[0];
    lbl.textContent = uAct ? uAct.rol : '—';

    sel.addEventListener('change', ()=>{
      localStorage.setItem('pecuario_usuario_actual', sel.value);
      const uu = getUsuarios().find(x=>x.nombre===sel.value);
      lbl.textContent = uu ? uu.rol : '—';
      aplicarPermisos();
      if (typeof poblarSelectUsuariosAsignacion === 'function') poblarSelectUsuariosAsignacion();
      if (window.renderTareasUI) window.renderTareasUI();
    });
  }

  
  function aplicarPermisosPanel(permisos){
    // Oculta tarjetas del panel si el usuario no tiene permiso del módulo asociado
    document.querySelectorAll('#mod-panel .tarjetas-grid .tarjeta[data-perm]').forEach(card=>{
      const need = card.getAttribute('data-perm');
      card.style.display = permisos.includes(need) ? '' : 'none';
    });
  }

  function aplicarPermisos(){
    const nombre = localStorage.getItem('pecuario_usuario_actual') || '';
    const u = getUsuarios().find(x=>x.nombre===nombre) || null;
    const permisos = u ? (u.permisos||[]) : MODS.map(m=>m.id);

    document.querySelectorAll('nav button[data-modulo]').forEach(b=>{
      const id = b.getAttribute('data-modulo');
      const allow = (id === 'panel') || permisos.includes(id);
      b.style.display = allow ? '' : 'none';
    });

    aplicarPermisosPanel(permisos);
    aplicarPermisosReportes();
  }

  (function initUsuarios(){
    asegurarUsuarioDefault();
    renderPermisosCheckboxes();
    renderListaUsuarios();
    llenarUsuariosHeader();
    aplicarPermisos();

    const form = document.getElementById('form-usuarios');
    if (!form) return;

    // Rol: 'Otro' con nombre editable
    const selRol = form.querySelector('select[name="rol"]');
    const wrapOtro = document.getElementById('rolOtroWrap');
    const inpOtro = form.querySelector('input[name="rolOtro"]');
    const toggleOtro = ()=>{
      const v = selRol ? selRol.value : '';
      const show = (v === 'Otro');
      if (wrapOtro) wrapOtro.style.display = show ? '' : 'none';
      if (inpOtro){
        inpOtro.required = show;
        if (!show) inpOtro.value = '';
      }
    };
    if (selRol) selRol.addEventListener('change', toggleOtro);
    toggleOtro();

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const datos = new FormData(form);
      const obj = {};
      datos.forEach((v,k)=>obj[k]=String(v||''));
      // Normalizar rol (con 'Otro' editable)
      const rolSel = (obj.rol||'').trim();
      const rolOtro = (obj.rolOtro||'').trim();
      if (rolSel === 'Otro'){
        if (!rolOtro){ alert('Seleccionaste "Otro". Escribe el nombre del rol.'); return; }
        obj.rolBase = 'Otro';
        obj.rol = rolOtro;
      } else {
        obj.rolBase = rolSel;
        obj.rol = rolSel;
      }
      delete obj.rolOtro;

      const perms = [];
      MODS.forEach(m=>{
        const chk = document.getElementById('perm_'+m.id);
        if (chk && chk.checked) perms.push(m.id);
      });
      obj.permisos = perms;
      const usuarios = getUsuarios();
      usuarios.push(obj);
      setUsuarios(usuarios);
      pintarToast('Usuario guardado');
      form.reset();
      renderPermisosCheckboxes();
      renderListaUsuarios();
      llenarUsuariosHeader();
      aplicarPermisos();
      if (typeof poblarSelectUsuariosAsignacion === 'function') poblarSelectUsuariosAsignacion();
      if (window.renderTareasUI) window.renderTareasUI();
    });
  })();


  // ======================
  // Init UI
  // ======================
  refrescarRazasEnUI();
  refrescarGruposEnUI();
  refrescarPotrerosEnUI();

    // Extras
  refrescarSelectorAnimalesCambioGrupo();
  renderPermReportesUI();
  aplicarPermisosReportes();

  // Botón: cambiar grupo desde Inventario
  (function(){
    const btn = document.getElementById('btnCambiarGrupoAnimal');
    if (!btn) return;
    btn.addEventListener('click', ()=>{
      const selA = document.getElementById('selAnimalCambioGrupo');
      const selG = document.getElementById('selNuevoGrupoAnimal');
      if (!selA || !selG) return;
      cambiarGrupoAnimal(selA.value, selG.value);
    });
  })();

// Listas iniciales
  pintarLista('pecuario_pesaje_ind', 'lista-pesaje-ind', (p) => {
    const deltaObj = ultimoPesajeAnimal(p.areteOficial);
    const deltaTxt = deltaObj ? ` | Δ vs último: ${deltaObj.delta.toFixed(1)} kg` : '';
    return `Arete ${p.areteOficial || '-'} | Fecha: ${p.fecha || '-'} | Peso: ${p.peso || ''} kg | Ubicación: ${p.ubicacion || '-'}${deltaTxt}`;
  });
  pintarLista('pecuario_pesaje_grupo', 'lista-pesaje-grupo', (p) => {
    const prom = parseFloat(p.pesoProm||0) || 0;
    const delta = p.deltaProm ? ` | Δ prom: ${p.deltaProm} kg/cab` : '';
    return `Grupo ${p.grupo || '-'} | Fecha: ${p.fecha || '-'} | Potrero: ${p.potrero || '-'} | Corral: ${p.corral || '-'} | Cabezas: ${p.cabezas || ''} | Total: ${p.pesoTotal || ''} kg | Prom: ${prom.toFixed(1)} kg/cab${delta}`;
  });

  pintarSuplementos();
  renderPuntos();
  actualizarPanel();
  actualizarReportes();
</script>
</body>
</html>
